{"version":3,"file":"content-script.js","mappings":"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","sources":["webpack://toperparty/./chrome-extension/src/managers/sync/lock.js","webpack://toperparty/./chrome-extension/src/managers/sync/debounce.js","webpack://toperparty/./chrome-extension/src/managers/sync/SyncManager.js","webpack://toperparty/./chrome-extension/src/services/webrtc/peerConnection.js","webpack://toperparty/./chrome-extension/src/content/main.js","webpack://toperparty/./chrome-extension/src/managers/state/StateManager.js","webpack://toperparty/./chrome-extension/src/ui/UIManager.js","webpack://toperparty/./chrome-extension/src/content/netflix/NetflixController.js","webpack://toperparty/./chrome-extension/src/managers/sync/remoteHandlers.js","webpack://toperparty/./chrome-extension/src/managers/sync/eventListeners.js","webpack://toperparty/./chrome-extension/src/services/webrtc/WebRTCManager.js","webpack://toperparty/./chrome-extension/src/services/webrtc/ui.js","webpack://toperparty/./chrome-extension/src/services/webrtc/reconnect.js","webpack://toperparty/./chrome-extension/src/services/webrtc/signaling.js","webpack://toperparty/./chrome-extension/src/managers/url/URLSync.js"],"sourcesContent":["export class SyncLock {\n  constructor() {\n    this.suppressLocalUntil = 0;\n  }\n  set(durationMs) {\n    this.suppressLocalUntil = Date.now() + durationMs;\n  }\n  isActive() {\n    return Date.now() < this.suppressLocalUntil;\n  }\n}\n","export class EventDebouncer {\n  constructor(delayMs = 200) {\n    this.delayMs = delayMs;\n    this.timer = null;\n    this.events = new Set();\n  }\n  add(eventType) {\n    this.events.add(eventType);\n  }\n  schedule(fn) {\n    if (this.timer) clearTimeout(this.timer);\n    this.timer = setTimeout(() => {\n      const events = this.events;\n      this.events = new Set();\n      this.timer = null;\n      fn(events);\n    }, this.delayMs);\n  }\n  cancel() {\n    if (this.timer) clearTimeout(this.timer);\n    this.timer = null;\n    this.events.clear();\n  }\n}\n","import { SyncLock } from './lock.js';\nimport { EventDebouncer } from './debounce.js';\nimport { attachPlaybackListeners } from './eventListeners.js';\nimport { createRemoteHandlers } from './remoteHandlers.js';\n\nclass MutableRef {\n  constructor(value) { this.value = value; }\n  get() { return this.value; }\n  set(v) { this.value = v; }\n}\n\nexport class SyncManager {\n  constructor(stateManager, netflixController) {\n    this.state = stateManager;\n    this.netflix = netflixController;\n    this.lock = new SyncLock();\n    this.debouncer = new EventDebouncer(200);\n    this.isInitializedRef = new MutableRef(false);\n    this.listeners = null;\n    this.contextRef = new MutableRef({ lastUserInteractionAt: 0 });\n\n    this.remote = createRemoteHandlers({\n      state: this.state,\n      netflix: this.netflix,\n      lock: this.lock,\n      isInitializedRef: this.isInitializedRef,\n      contextRef: this.contextRef,\n    });\n  }\n\n  async setup() {\n    try {\n      const video = await this.waitForVideo();\n      if (!video) { console.warn('[SyncManager] Netflix video element not found'); return; }\n      this.isInitializedRef.set(false);\n      this.state.safeSendMessage({ type: 'REQUEST_SYNC' });\n      setTimeout(() => {\n        if (!this.isInitializedRef.get()) { this.isInitializedRef.set(true); }\n      }, 2000);\n      const listeners = attachPlaybackListeners({\n        video,\n        state: this.state,\n        isInitializedRef: this.isInitializedRef,\n        lock: this.lock,\n        debouncer: this.debouncer,\n        onBroadcast: (vid) => this.broadcastLocalState(vid),\n        onPassiveSyncContext: ({ now }) => {\n          this.state.safeSendMessage({\n            type: 'SYNC_TIME',\n            currentTime: video.currentTime,\n            isPlaying: !video.paused,\n            timestamp: now,\n          });\n        }\n      });\n      this.listeners = listeners;\n      this.contextRef.set(listeners.context);\n    } catch (err) { console.error('[SyncManager] Error setting up playback sync:', err); }\n  }\n\n  teardown() {\n    if (this.listeners && this.listeners.video) {\n      const { video, handleLocalEvent, handleTimeUpdate } = this.listeners;\n      try {\n        video.removeEventListener('play', handleLocalEvent);\n        video.removeEventListener('pause', handleLocalEvent);\n        video.removeEventListener('seeked', handleLocalEvent);\n        video.removeEventListener('timeupdate', handleTimeUpdate);\n      } catch (e) { console.warn('[SyncManager] Error removing listeners:', e); }\n      this.listeners = null;\n    }\n    this.debouncer.cancel();\n  }\n\n  waitForVideo() {\n    return new Promise((resolve, reject) => {\n      const timeout = setTimeout(() => reject(new Error('Video element timeout')), 10000);\n      const check = () => {\n        const video = this.netflix.getVideoElement();\n        if (video) { clearTimeout(timeout); resolve(video); }\n        else { setTimeout(check, 100); }\n      };\n      check();\n    });\n  }\n\n  broadcastLocalState(video) {\n    const currentTime = video.currentTime;\n    const isPlaying = !video.paused;\n    const events = new Set(this.debouncer.events);\n    // Priority: Seek > Play/Pause\n    if (events.has('seeked')) {\n      this.state.safeSendMessage({ type: 'SEEK', currentTime, isPlaying });\n    } else if (events.has('play') || events.has('pause')) {\n      const control = isPlaying ? 'play' : 'pause';\n      this.state.safeSendMessage({ type: 'PLAY_PAUSE', control, timestamp: currentTime });\n    }\n  }\n\n  // Remote API mirrors original methods\n  handleRequestSync(fromUserId) { return this.remote.handleRequestSync(fromUserId); }\n  handleSyncResponse(currentTime, isPlaying, fromUserId) { return this.remote.handleSyncResponse(currentTime, isPlaying, fromUserId); }\n  handlePlaybackControl(control, fromUserId) { return this.remote.handlePlaybackControl(control, fromUserId); }\n  handleSeek(currentTime, isPlaying, fromUserId) { return this.remote.handleSeek(currentTime, isPlaying, fromUserId); }\n  handlePassiveSync(currentTime, isPlaying, fromUserId, timestamp) { return this.remote.handlePassiveSync(currentTime, isPlaying, fromUserId, timestamp); }\n}\n","export function createPeerConnectionFactory({ stateManager, sendSignal, remoteStreams, remoteVideos, addRemoteVideo, attemptReconnection, clearReconnection, removeRemoteVideo, peersThatLeft }) {\n  return function createPeerConnection(peerId) {\n    const state = stateManager.getState();\n    const pc = new RTCPeerConnection({\n      iceServers: [\n        { urls: ['stun:stun.l.google.com:19302'] },\n        { urls: ['stun:stun1.l.google.com:19302'] }\n      ]\n    });\n    pc.onicecandidate = (event) => {\n      if (event.candidate) {\n        console.log('[PeerConnection] ICE candidate for peer:', peerId, event.candidate);\n        sendSignal({ type: 'ICE_CANDIDATE', from: state.userId, to: peerId, candidate: event.candidate });\n      }\n    };\n    pc.ontrack = (event) => {\n      console.log('[PeerConnection] ontrack fired for peer:', peerId, 'track:', event.track, 'streams:', event.streams);\n      let stream = (event.streams && event.streams[0]) || remoteStreams.get(peerId);\n      if (!stream) {\n        console.log('[PeerConnection] Creating new MediaStream for peer:', peerId);\n        stream = new MediaStream();\n        remoteStreams.set(peerId, stream);\n      }\n      if (event.track) {\n        console.log('[PeerConnection] Adding track to stream:', event.track.kind, event.track.id);\n        try { stream.addTrack(event.track); } catch (e) {\n          console.warn('[PeerConnection] Error adding track:', e);\n        }\n      }\n      if (!remoteVideos.has(peerId)) {\n        console.log('[PeerConnection] Adding remote video for peer:', peerId, 'stream tracks:', stream.getTracks().length);\n        addRemoteVideo(peerId, stream);\n      }\n    };\n    pc.onconnectionstatechange = () => {\n      console.log('[PeerConnection] Connection state changed for peer:', peerId, 'â†’', pc.connectionState);\n      if (pc.connectionState === 'connected') {\n        clearReconnection(peerId);\n      } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {\n        if (peersThatLeft.has(peerId)) {\n          removeRemoteVideo(peerId);\n          clearReconnection(peerId);\n        } else {\n          removeRemoteVideo(peerId);\n          attemptReconnection(peerId);\n        }\n      } else if (pc.connectionState === 'closed') {\n        removeRemoteVideo(peerId);\n        clearReconnection(peerId);\n      }\n    };\n    return pc;\n  };\n}\n\nexport function addOrReplaceTrack(pc, track, stream) {\n  const senders = pc.getSenders();\n  const existingSender = senders.find(s => s.track && s.track.kind === track.kind);\n  if (existingSender) {\n    existingSender.replaceTrack(track).catch(e => console.warn('[WebRTCManager] Error replacing track', e));\n  } else {\n    try { pc.addTrack(track, stream); } catch (e) {}\n  }\n}\n","import { StateManager } from '../managers/state/StateManager.js';\nimport { NetflixController } from './netflix/NetflixController.js';\nimport { SyncManager } from '../managers/sync/SyncManager.js';\nimport { WebRTCManager } from '../services/webrtc/WebRTCManager.js';\nimport { UIManager } from '../ui/UIManager.js';\nimport { URLSync } from '../managers/url/URLSync.js';\n\nconsole.log('[Content Script] Initializing managers...');\nconst stateManager = new StateManager();\nconst uiManager = new UIManager();\nconst netflixController = new NetflixController();\nconst syncManager = new SyncManager(stateManager, netflixController);\nconst webrtcManager = new WebRTCManager(stateManager, uiManager);\nconst urlSync = new URLSync(stateManager);\nconsole.log('[Content Script] Managers initialized');\n\nlet localStream = null;\n\n(function checkRestorePartyState() {\n  const restorationState = urlSync.getRestorationState();\n  if (restorationState) {\n    urlSync.clearState();\n    stateManager.setRestoringFlag(true);\n    setTimeout(function() {\n      chrome.runtime.sendMessage({ type: 'RESTORE_PARTY', roomId: restorationState.roomId });\n      setTimeout(function() {\n        stateManager.setRestoringFlag(false);\n      }, 2000);\n    }, 1000);\n  }\n})();\n\nchrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n  console.log('[Content Script] Received message:', request.type);\n  if (request.type === 'REQUEST_MEDIA_STREAM') {\n    navigator.mediaDevices.getUserMedia({ video: true, audio: true })\n      .then(stream => {\n        localStream = stream;\n        webrtcManager.setLocalStream(stream);\n        webrtcManager.onLocalStreamAvailable(stream);\n        sendResponse({ success: true });\n      })\n      .catch(err => sendResponse({ success: false, error: err.message }));\n    return true;\n  }\n\n  if (request.type === 'PARTY_STARTED') {\n    console.log('[Content Script] Party started:', request.userId, request.roomId);\n    stateManager.startParty(request.userId, request.roomId);\n    syncManager.setup();\n    urlSync.start();\n    sendResponse({ success: true });\n  }\n\n  if (request.type === 'PARTY_STOPPED') {\n    stateManager.stopParty();\n    syncManager.teardown();\n    urlSync.stop();\n    urlSync.clearState();\n    webrtcManager.clearAll();\n    if (localStream) {\n      localStream.getTracks().forEach(t => t.stop());\n      localStream = null;\n    }\n    sendResponse({ success: true });\n  }\n\n  if (request.type === 'SIGNAL') {\n    console.log('[Content Script] Handling SIGNAL:', request.message?.type);\n    webrtcManager.handleSignal(request.message);\n  }\n\n  if (request.type === 'APPLY_PLAYBACK_CONTROL') {\n    syncManager.handlePlaybackControl(request.control, request.fromUserId);\n  }\n\n  if (request.type === 'APPLY_SYNC_PLAYBACK') {\n    syncManager.handlePassiveSync(request.currentTime, request.isPlaying, request.fromUserId, request.timestamp);\n  }\n\n  if (request.type === 'APPLY_SEEK') {\n    syncManager.handleSeek(request.currentTime, request.isPlaying, request.fromUserId);\n  }\n\n  if (request.type === 'APPLY_URL_CHANGE') {\n    if (!stateManager.restoringPartyState) {\n      window.location.href = request.url;\n    }\n  }\n\n  if (request.type === 'HANDLE_REQUEST_SYNC') {\n    syncManager.handleRequestSync(request.fromUserId);\n  }\n\n  if (request.type === 'APPLY_SYNC_RESPONSE') {\n    syncManager.handleSyncResponse(request.currentTime, request.isPlaying, request.fromUserId);\n  }\n});\n\nwindow.addEventListener('beforeunload', () => {\n  if (stateManager.isActive()) {\n    urlSync.saveState();\n  }\n});\n","export class StateManager {\n  constructor() {\n    this.partyActive = false;\n    this.userId = null;\n    this.roomId = null;\n    this.restoringPartyState = false;\n  }\n  startParty(userId, roomId) {\n    this.partyActive = true;\n    this.userId = userId;\n    this.roomId = roomId;\n  }\n  stopParty() {\n    this.partyActive = false;\n    this.userId = null;\n    this.roomId = null;\n  }\n  isActive() { return this.partyActive; }\n  getUserId() { return this.userId; }\n  getRoomId() { return this.roomId; }\n  getState() {\n    return { partyActive: this.partyActive, userId: this.userId, roomId: this.roomId, restoringPartyState: this.restoringPartyState };\n  }\n  isInParty() { return !!(this.partyActive && this.userId && this.roomId); }\n  setRestoringFlag(value) { this.restoringPartyState = value; }\n  isExtensionContextValid() {\n    try { return chrome.runtime && chrome.runtime.id; } catch { return false; }\n  }\n  safeSendMessage(message, callback) {\n    if (!this.isExtensionContextValid()) return;\n    try { chrome.runtime.sendMessage(message, callback); } catch (e) { console.warn('Failed to send message:', e.message); }\n  }\n}\n","export class UIManager {\n  constructor() {\n    this.localPreviewVideo = null;\n    this.remoteVideos = new Map();\n    this.remoteStreams = new Map();\n    this.streamMonitorInterval = null;\n  }\n  getRemoteVideos() { return this.remoteVideos; }\n  getRemoteStreams() { return this.remoteStreams; }\n  setLocalPreviewVideo(video) { this.localPreviewVideo = video; }\n  getLocalPreviewVideo() { return this.localPreviewVideo; }\n  setStreamMonitorInterval(interval) { this.streamMonitorInterval = interval; }\n  getStreamMonitorInterval() { return this.streamMonitorInterval; }\n  clearStreamMonitorInterval() {\n    if (this.streamMonitorInterval) {\n      clearInterval(this.streamMonitorInterval);\n      this.streamMonitorInterval = null;\n    }\n  }\n  clearAll() {\n    this.localPreviewVideo = null;\n    this.remoteVideos.clear();\n    this.remoteStreams.clear();\n    this.clearStreamMonitorInterval();\n  }\n}\n","export class NetflixController {\n  constructor() { this.injectAPIBridge(); }\n  injectAPIBridge() {\n    const script = document.createElement('script');\n    script.src = chrome.runtime.getURL('netflix-api-bridge.js');\n    (document.head || document.documentElement).appendChild(script);\n    script.onload = function() { script.remove(); };\n  }\n  _sendCommand(command, args = []) {\n    return new Promise(function(resolve) {\n      const handler = function(e) {\n        if (e.detail.command === command) {\n          document.removeEventListener('__toperparty_response', handler);\n          resolve(e.detail.result);\n        }\n      };\n      document.addEventListener('__toperparty_response', handler);\n      setTimeout(function() { resolve(null); }, 1000);\n      document.dispatchEvent(new CustomEvent('__toperparty_command', { detail: { command, args } }));\n    });\n  }\n  play() { return this._sendCommand('play'); }\n  pause() { return this._sendCommand('pause'); }\n  seek(timeMs) { return this._sendCommand('seek', [timeMs]); }\n  getCurrentTime() { return this._sendCommand('getCurrentTime'); }\n  isPaused() { return this._sendCommand('isPaused'); }\n  getVideoElement() { return document.querySelector('video'); }\n}\n","export function createRemoteHandlers({ state, netflix, lock, isInitializedRef, contextRef }) {\n  async function applyRemote(actionName, durationMs, actionFn) {\n    lock.set(durationMs);\n    try { await actionFn(); } catch (err) {\n      console.error(`[SyncManager] Error applying remote ${actionName}:`, err);\n    }\n  }\n\n  return {\n    async handleRequestSync(fromUserId) {\n      if (!isInitializedRef.get()) return;\n      try {\n        const currentTime = await netflix.getCurrentTime();\n        const isPaused = await netflix.isPaused();\n        state.safeSendMessage({\n          type: 'SYNC_RESPONSE',\n          targetUserId: fromUserId,\n          currentTime: currentTime / 1000,\n          isPlaying: !isPaused\n        });\n      } catch (e) { console.error('[SyncManager] Error handling sync request:', e); }\n    },\n    async handleSyncResponse(currentTime, isPlaying, fromUserId) {\n      if (isInitializedRef.get()) return;\n      isInitializedRef.set(true);\n      await applyRemote('initial-sync', 2000, async () => {\n        await netflix.seek(currentTime * 1000);\n        const localPaused = await netflix.isPaused();\n        if (isPlaying && localPaused) await netflix.play();\n        else if (!isPlaying && !localPaused) await netflix.pause();\n      });\n    },\n    async handlePlaybackControl(control) {\n      await applyRemote(control, 1000, async () => {\n        if (control === 'play') await netflix.play();\n        else await netflix.pause();\n      });\n    },\n    async handleSeek(currentTime, isPlaying) {\n      await applyRemote('seek', 2000, async () => {\n        await netflix.seek(currentTime * 1000);\n        const isPaused = await netflix.isPaused();\n        if (isPlaying && isPaused) await netflix.play();\n        else if (!isPlaying && !isPaused) await netflix.pause();\n      });\n    },\n    async handlePassiveSync(currentTime, isPlaying, fromUserId, timestamp) {\n      const now = Date.now();\n      if (timestamp && (now - timestamp > 5000)) return;\n      if (now - contextRef.get().lastUserInteractionAt < 10000) return;\n      if (lock.isActive()) return;\n      try {\n        const localTimeMs = await netflix.getCurrentTime();\n        const targetMs = currentTime * 1000;\n        const driftMs = Math.abs(localTimeMs - targetMs);\n        if (driftMs <= 3000) return;\n        await applyRemote('passive-correction', 1500, async () => {\n          await netflix.seek(targetMs);\n          const localPaused = await netflix.isPaused();\n          if (isPlaying && localPaused) await netflix.play();\n          else if (!isPlaying && !localPaused) await netflix.pause();\n        });\n      } catch (err) { console.error('[SyncManager] Error handling passive sync:', err); }\n    }\n  };\n}\n","export function attachPlaybackListeners({ video, state, isInitializedRef, lock, debouncer, onBroadcast, onPassiveSyncContext }) {\n  const context = { lastUserInteractionAt: 0 };\n  const handleLocalEvent = (e) => {\n    if (!state.isActive()) return;\n    if (!isInitializedRef.get()) return;\n    if (lock.isActive()) return;\n    context.lastUserInteractionAt = Date.now();\n    debouncer.add(e.type);\n    debouncer.schedule(() => onBroadcast(video));\n  };\n\n  let lastPassiveSentAt = 0;\n  const handleTimeUpdate = () => {\n    if (!state.isActive()) return;\n    const now = Date.now();\n    if (lock.isActive()) return;\n    if (now - context.lastUserInteractionAt < 5000) return;\n    if (now - lastPassiveSentAt < 10000) return;\n    if (video.paused) return;\n    lastPassiveSentAt = now;\n    onPassiveSyncContext({ now, lastPassiveSentAt });\n  };\n\n  video.addEventListener('play', handleLocalEvent);\n  video.addEventListener('pause', handleLocalEvent);\n  video.addEventListener('seeked', handleLocalEvent);\n  video.addEventListener('timeupdate', handleTimeUpdate);\n\n  return { video, handleLocalEvent, handleTimeUpdate, context };\n}\n","import { createSignalingHandlers } from './signaling.js';\nimport { createPeerConnectionFactory, addOrReplaceTrack } from './peerConnection.js';\nimport { createReconnectionManager } from './reconnect.js';\nimport { createRemoteVideoManager } from './ui.js';\n\nexport class WebRTCManager {\n  constructor(stateManager, uiManager) {\n    this.stateManager = stateManager;\n    this.uiManager = uiManager;\n    this.peerConnections = new Map();\n    this.remoteStreams = this.uiManager.getRemoteStreams();\n    this.remoteVideos = this.uiManager.getRemoteVideos();\n    this.peersThatLeft = new Set();\n    this.localStream = null;\n\n    const videoManager = createRemoteVideoManager(this.remoteVideos);\n    \n    const reconnectionManager = createReconnectionManager({\n      stateManager: this.stateManager,\n      peerConnections: this.peerConnections,\n      peersThatLeft: this.peersThatLeft,\n      localStream: () => this.localStream,\n      createPeer: null,\n      sendSignal: (msg) => this._sendSignal(msg),\n      addOrReplaceTrack\n    });\n\n    const createPeer = createPeerConnectionFactory({\n      stateManager: this.stateManager,\n      sendSignal: (msg) => this._sendSignal(msg),\n      remoteStreams: this.remoteStreams,\n      remoteVideos: this.remoteVideos,\n      addRemoteVideo: videoManager.add,\n      attemptReconnection: reconnectionManager.attempt,\n      clearReconnection: reconnectionManager.clear,\n      removeRemoteVideo: (peerId) => {\n        videoManager.remove(peerId);\n        this.remoteStreams.delete(peerId);\n      },\n      peersThatLeft: this.peersThatLeft\n    });\n\n    reconnectionManager.createPeer = createPeer;\n    this.reconnectionManager = reconnectionManager;\n    this.createPeer = createPeer;\n    this.videoManager = videoManager;\n\n    this.signalingHandlers = createSignalingHandlers({\n      getState: () => this.stateManager.getState(),\n      peerConnections: this.peerConnections,\n      peersThatLeft: this.peersThatLeft,\n      getLocalStream: () => this.localStream,\n      createPeer,\n      sendSignal: (msg) => this._sendSignal(msg),\n      addOrReplaceTrack,\n      clearReconnection: reconnectionManager.clear,\n      removeRemoteVideo: (peerId) => {\n        videoManager.remove(peerId);\n        this.remoteStreams.delete(peerId);\n      }\n    });\n  }\n\n  setLocalStream(stream) { this.localStream = stream; }\n  getLocalStream() { return this.localStream; }\n  \n  onLocalStreamAvailable(stream) {\n    this.localStream = stream;\n    this.peerConnections.forEach((pc) => {\n      try {\n        stream.getTracks().forEach(t => addOrReplaceTrack(pc, t, stream));\n      } catch (e) {}\n    });\n  }\n\n  async handleSignal(message) {\n    console.log('[WebRTCManager] handleSignal called with:', message);\n    if (!message || !message.type) {\n      console.warn('[WebRTCManager] Invalid message:', message);\n      return;\n    }\n    const type = message.type;\n    const from = message.userId || message.from;\n    const to = message.to;\n    const state = this.stateManager.getState();\n    console.log('[WebRTCManager] Processing signal type:', type, 'from:', from, 'to:', to, 'myId:', state.userId);\n    \n    if (to && to !== state.userId) {\n      console.log('[WebRTCManager] Ignoring message not meant for me');\n      return;\n    }\n\n    if (type === 'JOIN' && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleJoin');\n      await this.signalingHandlers.handleJoin(from);\n    } else if (type === 'OFFER' && message.offer && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleOffer');\n      await this.signalingHandlers.handleOffer(from, message.offer);\n    } else if (type === 'ANSWER' && message.answer && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleAnswer');\n      await this.signalingHandlers.handleAnswer(from, message.answer);\n    } else if (type === 'ICE_CANDIDATE' && message.candidate && from && from !== state.userId) {\n      console.log('[WebRTCManager] Dispatching to handleIceCandidate');\n      await this.signalingHandlers.handleIceCandidate(from, message.candidate);\n    } else if (type === 'LEAVE' && from) {\n      console.log('[WebRTCManager] Dispatching to handleLeave');\n      this.signalingHandlers.handleLeave(from);\n    } else {\n      console.log('[WebRTCManager] Signal not handled - type:', type, 'from:', from, 'conditions not met');\n    }\n  }\n\n  attemptReconnection(peerId) {\n    return this.reconnectionManager.attempt(peerId);\n  }\n\n  _sendSignal(message) {\n    this.stateManager.safeSendMessage({ type: 'SIGNAL_SEND', message }, function() {});\n  }\n\n  clearAll() {\n    this.peerConnections.forEach((pc) => {\n      try { pc.close(); } catch (e) {}\n    });\n    this.peerConnections.clear();\n    this.peersThatLeft.clear();\n    this.remoteVideos.forEach((v) => {\n      try { if (v.srcObject) v.srcObject = null; } catch (e) {}\n      v.remove();\n    });\n    this.remoteVideos.clear();\n    this.remoteStreams.clear();\n    if (this.localStream) {\n      this.localStream.getTracks().forEach(track => track.stop());\n      this.localStream = null;\n    }\n  }\n}\n","export function createRemoteVideoManager(remoteVideos) {\n  function add(peerId, stream) {\n    console.log('[RemoteVideoManager] Adding remote video for peer:', peerId, 'stream:', stream, 'tracks:', stream.getTracks());\n    remove(peerId);\n    const v = document.createElement('video');\n    v.id = 'toperparty-remote-' + peerId;\n    v.autoplay = true;\n    v.playsInline = true;\n    v.muted = true;\n    v.style.position = 'fixed';\n    v.style.bottom = '20px';\n    v.style.right = (20 + (remoteVideos.size * 180)) + 'px';\n    v.style.width = '240px';\n    v.style.height = '160px';\n    v.style.zIndex = 10001;\n    v.style.border = '2px solid #00aaff';\n    v.style.borderRadius = '4px';\n    console.log('[RemoteVideoManager] Created video element:', v.id, 'at position:', v.style.right);\n    try { \n      v.srcObject = stream;\n      console.log('[RemoteVideoManager] Set srcObject successfully');\n    } catch (e) { \n      console.warn('[RemoteVideoManager] srcObject failed, trying createObjectURL:', e);\n      v.src = URL.createObjectURL(stream); \n    }\n    document.body.appendChild(v);\n    console.log('[RemoteVideoManager] Appended video to body');\n    remoteVideos.set(peerId, v);\n    try {\n      v.play().then(() => {\n        console.log('[RemoteVideoManager] Video playing, unmuting');\n        v.muted = false;\n        v.volume = 1.0;\n      }).catch((e) => { \n        console.warn('[RemoteVideoManager] Play failed:', e);\n        v.muted = false; \n      });\n    } catch (e) {\n      console.warn('[RemoteVideoManager] Error calling play:', e);\n    }\n  }\n  \n  function remove(peerId) {\n    console.log('[RemoteVideoManager] Removing remote video for peer:', peerId);\n    const v = remoteVideos.get(peerId);\n    if (v) {\n      try { if (v.srcObject) v.srcObject = null; } catch (e) {}\n      v.remove();\n      remoteVideos.delete(peerId);\n    }\n  }\n  \n  return { add, remove };\n}\n","export function createReconnectionManager({ stateManager, peerConnections, peersThatLeft, localStream, createPeer, sendSignal, addOrReplaceTrack }) {\n  const attempts = new Map();\n  const timeouts = new Map();\n  \n  function clear(peerId) {\n    attempts.delete(peerId);\n    const handle = timeouts.get(peerId);\n    if (handle) {\n      clearTimeout(handle);\n      timeouts.delete(peerId);\n    }\n  }\n  \n  async function attempt(peerId) {\n    if (!stateManager.isInParty()) return;\n    if (peersThatLeft.has(peerId)) {\n      clear(peerId);\n      return;\n    }\n    const count = attempts.get(peerId) || 0;\n    const maxAttempts = 5;\n    const backoffDelay = Math.min(1000 * Math.pow(2, count), 30000);\n    if (count >= maxAttempts) {\n      clear(peerId);\n      return;\n    }\n    attempts.set(peerId, count + 1);\n    const existing = timeouts.get(peerId);\n    if (existing) clearTimeout(existing);\n    const handle = setTimeout(async () => {\n      const oldPc = peerConnections.get(peerId);\n      if (oldPc) {\n        try { oldPc.close(); } catch (e) {}\n        peerConnections.delete(peerId);\n      }\n      try {\n        const pc = createPeer(peerId);\n        peerConnections.set(peerId, pc);\n        if (localStream) {\n          localStream.getTracks().forEach(t => addOrReplaceTrack(pc, t, localStream));\n        }\n        const offer = await pc.createOffer();\n        await pc.setLocalDescription(offer);\n        const state = stateManager.getState();\n        sendSignal({ type: 'OFFER', from: state.userId, to: peerId, offer: pc.localDescription });\n      } catch (err) {\n        console.error('[WebRTCManager] Reconnection failed:', err);\n        attempt(peerId);\n      }\n    }, backoffDelay);\n    timeouts.set(peerId, handle);\n  }\n  \n  return { attempt, clear };\n}\n","export function createSignalingHandlers({ getState, peerConnections, peersThatLeft, getLocalStream, createPeer, sendSignal, addOrReplaceTrack, clearReconnection, removeRemoteVideo }) {\n  return {\n    async handleJoin(from) {\n      console.log('[Signaling] Handling JOIN from', from);\n      const state = getState();\n      if (from === state.userId) {\n        console.log('[Signaling] Ignoring JOIN from self');\n        return;\n      }\n      peersThatLeft.delete(from);\n      if (peerConnections.has(from)) {\n        console.log('[Signaling] Already have peer connection for', from);\n        return;\n      }\n      try {\n        console.log('[Signaling] Creating peer connection for', from);\n        const pc = createPeer(from);\n        peerConnections.set(from, pc);\n        const stream = getLocalStream();\n        console.log('[Signaling] Local stream:', stream, 'tracks:', stream ? stream.getTracks().length : 0);\n        if (stream) {\n          stream.getTracks().forEach(t => {\n            console.log('[Signaling] Adding local track to peer:', t.kind, t.id);\n            addOrReplaceTrack(pc, t, stream);\n          });\n        } else {\n          console.warn('[Signaling] No local stream available when handling JOIN');\n        }\n        console.log('[Signaling] Creating and sending OFFER to', from);\n        const offer = await pc.createOffer();\n        await pc.setLocalDescription(offer);\n        sendSignal({ type: 'OFFER', from: state.userId, to: from, offer: pc.localDescription });\n      } catch (err) {\n        console.error('[Signaling] Error handling JOIN:', err);\n        peerConnections.delete(from);\n      }\n    },\n    async handleOffer(from, offer) {\n      console.log('[Signaling] Handling OFFER from', from);\n      const state = getState();\n      if (from === state.userId) {\n        console.log('[Signaling] Ignoring OFFER from self');\n        return;\n      }\n      let pc = peerConnections.get(from);\n      if (pc && pc.signalingState !== 'closed') {\n        console.log('[Signaling] Closing existing peer connection');\n        try { pc.close(); } catch (e) {}\n        peerConnections.delete(from);\n        pc = null;\n      }\n      if (!pc) {\n        console.log('[Signaling] Creating new peer connection for', from);\n        pc = createPeer(from);\n        peerConnections.set(from, pc);\n      }\n      try {\n        console.log('[Signaling] Setting remote description');\n        await pc.setRemoteDescription(new RTCSessionDescription(offer));\n        const stream = getLocalStream();\n        console.log('[Signaling] Local stream:', stream, 'tracks:', stream ? stream.getTracks().length : 0);\n        if (stream) {\n          stream.getTracks().forEach(t => {\n            console.log('[Signaling] Adding local track to peer:', t.kind, t.id);\n            addOrReplaceTrack(pc, t, stream);\n          });\n        } else {\n          console.warn('[Signaling] No local stream available when handling OFFER');\n        }\n        console.log('[Signaling] Creating and sending ANSWER to', from);\n        const answer = await pc.createAnswer();\n        await pc.setLocalDescription(answer);\n        sendSignal({ type: 'ANSWER', from: state.userId, to: from, answer: pc.localDescription });\n      } catch (err) {\n        console.error('[Signaling] Error handling offer:', err);\n        peerConnections.delete(from);\n        try { pc.close(); } catch (e) {}\n      }\n    },\n    async handleAnswer(from, answer) {\n      console.log('[Signaling] Handling ANSWER from', from);\n      const pc = peerConnections.get(from);\n      if (pc && pc.signalingState === 'have-local-offer') {\n        console.log('[Signaling] Setting remote description from ANSWER');\n        try {\n          await pc.setRemoteDescription(new RTCSessionDescription(answer));\n          console.log('[Signaling] Remote description set successfully');\n        } catch (err) {\n          console.error('[Signaling] Error handling answer:', err);\n        }\n      } else {\n        console.warn('[Signaling] Cannot handle ANSWER - pc:', !!pc, 'signalingState:', pc?.signalingState);\n      }\n    },\n    async handleIceCandidate(from, candidate) {\n      console.log('[Signaling] Handling ICE_CANDIDATE from', from);\n      const pc = peerConnections.get(from);\n      if (pc) {\n        try {\n          await pc.addIceCandidate(new RTCIceCandidate(candidate));\n          console.log('[Signaling] ICE candidate added successfully');\n        } catch (err) {\n          console.warn('[Signaling] Error adding ICE candidate', err);\n        }\n      } else {\n        console.warn('[Signaling] No peer connection found for ICE candidate from', from);\n      }\n    },\n    handleLeave(from) {\n      console.log('[Signaling] Handling LEAVE from', from);\n      peersThatLeft.add(from);\n      const pc = peerConnections.get(from);\n      if (pc) {\n        try { pc.close(); } catch (e) {}\n        peerConnections.delete(from);\n      }\n      clearReconnection(from);\n      removeRemoteVideo(from);\n    }\n  };\n}\n","export class URLSync {\n  constructor(stateManager) {\n    this.stateManager = stateManager;\n    this.urlMonitorInterval = null;\n    this.lastUrl = null;\n  }\n  start() { this.lastUrl = window.location.href; }\n  stop() {\n    if (this.urlMonitorInterval) { clearInterval(this.urlMonitorInterval); this.urlMonitorInterval = null; }\n  }\n  saveState() {\n    const state = this.stateManager.getState();\n    if (!state.partyActive) return;\n    const existing = this.getRestorationState() || {};\n    const payload = {\n      roomId: state.roomId,\n      currentTime: existing.currentTime || null,\n      isPlaying: typeof existing.isPlaying === 'boolean' ? existing.isPlaying : null,\n      timestamp: Date.now()\n    };\n    sessionStorage.setItem('toperparty_restore', JSON.stringify(payload));\n  }\n  clearState() { sessionStorage.removeItem('toperparty_restore'); }\n  getRestorationState() {\n    const stored = sessionStorage.getItem('toperparty_restore');\n    if (!stored) return null;\n    try {\n      const state = JSON.parse(stored);\n      if (Date.now() - state.timestamp < 30000) { return state; }\n    } catch (e) { console.error('[toperparty] Failed to parse restoration state:', e); }\n    return null;\n  }\n}\n"],"names":["SyncLock","constructor","this","suppressLocalUntil","set","durationMs","Date","now","isActive","EventDebouncer","delayMs","timer","events","Set","add","eventType","schedule","fn","clearTimeout","setTimeout","cancel","clear","MutableRef","value","get","v","addOrReplaceTrack","pc","track","stream","existingSender","getSenders","find","s","kind","replaceTrack","catch","e","console","warn","addTrack","log","stateManager","partyActive","userId","roomId","restoringPartyState","startParty","stopParty","getUserId","getRoomId","getState","isInParty","setRestoringFlag","isExtensionContextValid","chrome","runtime","id","safeSendMessage","message","callback","sendMessage","uiManager","localPreviewVideo","remoteVideos","Map","remoteStreams","streamMonitorInterval","getRemoteVideos","getRemoteStreams","setLocalPreviewVideo","video","getLocalPreviewVideo","setStreamMonitorInterval","interval","getStreamMonitorInterval","clearStreamMonitorInterval","clearInterval","clearAll","netflixController","injectAPIBridge","script","document","createElement","src","getURL","head","documentElement","appendChild","onload","remove","_sendCommand","command","args","Promise","resolve","handler","detail","removeEventListener","result","addEventListener","dispatchEvent","CustomEvent","play","pause","seek","timeMs","getCurrentTime","isPaused","getVideoElement","querySelector","syncManager","state","netflix","lock","debouncer","isInitializedRef","listeners","contextRef","lastUserInteractionAt","remote","async","applyRemote","actionName","actionFn","err","error","handleRequestSync","fromUserId","currentTime","type","targetUserId","isPlaying","handleSyncResponse","localPaused","handlePlaybackControl","control","handleSeek","handlePassiveSync","timestamp","localTimeMs","targetMs","Math","abs","createRemoteHandlers","setup","waitForVideo","onBroadcast","onPassiveSyncContext","context","handleLocalEvent","lastPassiveSentAt","handleTimeUpdate","paused","attachPlaybackListeners","vid","broadcastLocalState","teardown","reject","timeout","Error","check","has","webrtcManager","peerConnections","peersThatLeft","localStream","videoManager","peerId","srcObject","delete","getTracks","autoplay","playsInline","muted","style","position","bottom","right","size","width","height","zIndex","border","borderRadius","URL","createObjectURL","body","then","volume","createRemoteVideoManager","reconnectionManager","createPeer","sendSignal","attempts","timeouts","handle","attempt","count","backoffDelay","min","pow","existing","oldPc","close","forEach","t","offer","createOffer","setLocalDescription","from","to","localDescription","createReconnectionManager","msg","_sendSignal","addRemoteVideo","attemptReconnection","clearReconnection","removeRemoteVideo","RTCPeerConnection","iceServers","urls","onicecandidate","event","candidate","ontrack","streams","MediaStream","length","onconnectionstatechange","connectionState","createPeerConnectionFactory","signalingHandlers","getLocalStream","handleJoin","handleOffer","signalingState","setRemoteDescription","RTCSessionDescription","answer","createAnswer","handleAnswer","handleIceCandidate","addIceCandidate","RTCIceCandidate","handleLeave","createSignalingHandlers","setLocalStream","onLocalStreamAvailable","handleSignal","stop","urlSync","urlMonitorInterval","lastUrl","start","window","location","href","saveState","getRestorationState","payload","sessionStorage","setItem","JSON","stringify","clearState","removeItem","stored","getItem","parse","restorationState","onMessage","addListener","request","sender","sendResponse","navigator","mediaDevices","getUserMedia","audio","success","url"],"ignoreList":[],"sourceRoot":""}