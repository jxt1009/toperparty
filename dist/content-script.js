(()=>{"use strict";class e{constructor(){this.suppressLocalUntil=0}set(e){this.suppressLocalUntil=Date.now()+e}isActive(){return Date.now()<this.suppressLocalUntil}}class t{constructor(e=200){this.delayMs=e,this.timer=null,this.events=new Set}add(e){this.events.add(e)}schedule(e){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=this.events;this.events=new Set,this.timer=null,e(t)},this.delayMs)}cancel(){this.timer&&clearTimeout(this.timer),this.timer=null,this.events.clear()}}class n{constructor(e){this.value=e}get(){return this.value}set(e){this.value=e}}function a(e,t,n){const a=e.getSenders().find(e=>e.track&&e.track.kind===t.kind);if(a)a.replaceTrack(t).catch(e=>console.warn("[WebRTCManager] Error replacing track",e));else try{e.addTrack(t,n)}catch(e){}}console.log("[Content Script] Initializing managers...");const s=new class{constructor(){this.partyActive=!1,this.userId=null,this.roomId=null,this.restoringPartyState=!1}startParty(e,t){this.partyActive=!0,this.userId=e,this.roomId=t}stopParty(){this.partyActive=!1,this.userId=null,this.roomId=null}isActive(){return this.partyActive}getUserId(){return this.userId}getRoomId(){return this.roomId}getState(){return{partyActive:this.partyActive,userId:this.userId,roomId:this.roomId,restoringPartyState:this.restoringPartyState}}isInParty(){return!!(this.partyActive&&this.userId&&this.roomId)}setRestoringFlag(e){this.restoringPartyState=e}isExtensionContextValid(){try{return chrome.runtime&&chrome.runtime.id}catch{return!1}}safeSendMessage(e,t){if(this.isExtensionContextValid())try{chrome.runtime.sendMessage(e,t)}catch(e){console.warn("Failed to send message:",e.message)}}},r=new class{constructor(){this.localPreviewVideo=null,this.remoteVideos=new Map,this.remoteStreams=new Map,this.streamMonitorInterval=null}getRemoteVideos(){return this.remoteVideos}getRemoteStreams(){return this.remoteStreams}setLocalPreviewVideo(e){this.localPreviewVideo=e}getLocalPreviewVideo(){return this.localPreviewVideo}setStreamMonitorInterval(e){this.streamMonitorInterval=e}getStreamMonitorInterval(){return this.streamMonitorInterval}clearStreamMonitorInterval(){this.streamMonitorInterval&&(clearInterval(this.streamMonitorInterval),this.streamMonitorInterval=null)}clearAll(){this.localPreviewVideo=null,this.remoteVideos.clear(),this.remoteStreams.clear(),this.clearStreamMonitorInterval()}},o=new class{constructor(){this.injectAPIBridge()}injectAPIBridge(){const e=document.createElement("script");e.src=chrome.runtime.getURL("netflix-api-bridge.js"),(document.head||document.documentElement).appendChild(e),e.onload=function(){e.remove()}}_sendCommand(e,t=[]){return new Promise(function(n){const a=function(t){t.detail.command===e&&(document.removeEventListener("__toperparty_response",a),n(t.detail.result))};document.addEventListener("__toperparty_response",a),setTimeout(function(){n(null)},1e3),document.dispatchEvent(new CustomEvent("__toperparty_command",{detail:{command:e,args:t}}))})}play(){return this._sendCommand("play")}pause(){return this._sendCommand("pause")}seek(e){return this._sendCommand("seek",[e])}getCurrentTime(){return this._sendCommand("getCurrentTime")}isPaused(){return this._sendCommand("isPaused")}getVideoElement(){return document.querySelector("video")}},i=new class{constructor(a,s){this.state=a,this.netflix=s,this.lock=new e,this.debouncer=new t(200),this.isInitializedRef=new n(!1),this.listeners=null,this.contextRef=new n({lastUserInteractionAt:0}),this.remote=function({state:e,netflix:t,lock:n,isInitializedRef:a,contextRef:s}){async function r(e,t,a){n.set(t);try{await a()}catch(t){console.error(`[SyncManager] Error applying remote ${e}:`,t)}}return{async handleRequestSync(n){if(a.get())try{const a=await t.getCurrentTime(),s=await t.isPaused();e.safeSendMessage({type:"SYNC_RESPONSE",targetUserId:n,currentTime:a/1e3,isPlaying:!s})}catch(e){console.error("[SyncManager] Error handling sync request:",e)}},async handleSyncResponse(e,n,s){a.get()||(a.set(!0),await r("initial-sync",2e3,async()=>{await t.seek(1e3*e);const a=await t.isPaused();n&&a?await t.play():n||a||await t.pause()}))},async handlePlaybackControl(e){await r(e,1e3,async()=>{"play"===e?await t.play():await t.pause()})},async handleSeek(e,n){await r("seek",2e3,async()=>{await t.seek(1e3*e);const a=await t.isPaused();n&&a?await t.play():n||a||await t.pause()})},async handlePassiveSync(e,a,o,i){const c=Date.now();if(!(i&&c-i>5e3||c-s.get().lastUserInteractionAt<1e4||n.isActive()))try{const n=await t.getCurrentTime(),s=1e3*e;if(Math.abs(n-s)<=3e3)return;await r("passive-correction",1500,async()=>{await t.seek(s);const e=await t.isPaused();a&&e?await t.play():a||e||await t.pause()})}catch(e){console.error("[SyncManager] Error handling passive sync:",e)}}}}({state:this.state,netflix:this.netflix,lock:this.lock,isInitializedRef:this.isInitializedRef,contextRef:this.contextRef})}async setup(){try{const e=await this.waitForVideo();if(!e)return void console.warn("[SyncManager] Netflix video element not found");this.isInitializedRef.set(!1),this.state.safeSendMessage({type:"REQUEST_SYNC"}),setTimeout(()=>{this.isInitializedRef.get()||this.isInitializedRef.set(!0)},2e3);const t=function({video:e,state:t,isInitializedRef:n,lock:a,debouncer:s,onBroadcast:r,onPassiveSyncContext:o}){const i={lastUserInteractionAt:0},c=o=>{t.isActive()&&n.get()&&(a.isActive()||(i.lastUserInteractionAt=Date.now(),s.add(o.type),s.schedule(()=>r(e))))};let l=0;const d=()=>{if(!t.isActive())return;const n=Date.now();a.isActive()||n-i.lastUserInteractionAt<5e3||n-l<1e4||e.paused||(l=n,o({now:n,lastPassiveSentAt:l}))};return e.addEventListener("play",c),e.addEventListener("pause",c),e.addEventListener("seeked",c),e.addEventListener("timeupdate",d),{video:e,handleLocalEvent:c,handleTimeUpdate:d,context:i}}({video:e,state:this.state,isInitializedRef:this.isInitializedRef,lock:this.lock,debouncer:this.debouncer,onBroadcast:e=>this.broadcastLocalState(e),onPassiveSyncContext:({now:t})=>{this.state.safeSendMessage({type:"SYNC_TIME",currentTime:e.currentTime,isPlaying:!e.paused,timestamp:t})}});this.listeners=t,this.contextRef.set(t.context)}catch(e){console.error("[SyncManager] Error setting up playback sync:",e)}}teardown(){if(this.listeners&&this.listeners.video){const{video:e,handleLocalEvent:t,handleTimeUpdate:n}=this.listeners;try{e.removeEventListener("play",t),e.removeEventListener("pause",t),e.removeEventListener("seeked",t),e.removeEventListener("timeupdate",n)}catch(e){console.warn("[SyncManager] Error removing listeners:",e)}this.listeners=null}this.debouncer.cancel()}waitForVideo(){return new Promise((e,t)=>{const n=setTimeout(()=>t(new Error("Video element timeout")),1e4),a=()=>{const t=this.netflix.getVideoElement();t?(clearTimeout(n),e(t)):setTimeout(a,100)};a()})}broadcastLocalState(e){const t=e.currentTime,n=!e.paused,a=new Set(this.debouncer.events);if(a.has("seeked"))this.state.safeSendMessage({type:"SEEK",currentTime:t,isPlaying:n});else if(a.has("play")||a.has("pause")){const e=n?"play":"pause";this.state.safeSendMessage({type:"PLAY_PAUSE",control:e,timestamp:t})}}handleRequestSync(e){return this.remote.handleRequestSync(e)}handleSyncResponse(e,t,n){return this.remote.handleSyncResponse(e,t,n)}handlePlaybackControl(e,t){return this.remote.handlePlaybackControl(e,t)}handleSeek(e,t,n){return this.remote.handleSeek(e,t,n)}handlePassiveSync(e,t,n,a){return this.remote.handlePassiveSync(e,t,n,a)}}(s,o),c=new class{constructor(e,t){this.stateManager=e,this.uiManager=t,this.peerConnections=new Map,this.remoteStreams=this.uiManager.getRemoteStreams(),this.remoteVideos=this.uiManager.getRemoteVideos(),this.peersThatLeft=new Set,this.localStream=null;const n=function(e){function t(t){console.log("[RemoteVideoManager] Removing remote video for peer:",t);const n=e.get(t);if(n){try{n.srcObject&&(n.srcObject=null)}catch(e){}n.remove(),e.delete(t)}}return{add:function(n,a){console.log("[RemoteVideoManager] Adding remote video for peer:",n,"stream:",a,"tracks:",a.getTracks()),t(n);const s=document.createElement("video");s.id="toperparty-remote-"+n,s.autoplay=!0,s.playsInline=!0,s.muted=!0,s.style.position="fixed",s.style.bottom="20px",s.style.right=20+180*e.size+"px",s.style.width="240px",s.style.height="160px",s.style.zIndex=10001,s.style.border="2px solid #00aaff",s.style.borderRadius="4px",console.log("[RemoteVideoManager] Created video element:",s.id,"at position:",s.style.right);try{s.srcObject=a,console.log("[RemoteVideoManager] Set srcObject successfully")}catch(e){console.warn("[RemoteVideoManager] srcObject failed, trying createObjectURL:",e),s.src=URL.createObjectURL(a)}document.body.appendChild(s),console.log("[RemoteVideoManager] Appended video to body"),e.set(n,s);try{s.play().then(()=>{console.log("[RemoteVideoManager] Video playing, unmuting"),s.muted=!1,s.volume=1}).catch(e=>{console.warn("[RemoteVideoManager] Play failed:",e),s.muted=!1})}catch(e){console.warn("[RemoteVideoManager] Error calling play:",e)}},remove:t}}(this.remoteVideos),s=function({stateManager:e,peerConnections:t,peersThatLeft:n,localStream:a,createPeer:s,sendSignal:r,addOrReplaceTrack:o}){const i=new Map,c=new Map;function l(e){i.delete(e);const t=c.get(e);t&&(clearTimeout(t),c.delete(e))}return{attempt:async function d(h){if(!e.isInParty())return;if(n.has(h))return void l(h);const m=i.get(h)||0,u=Math.min(1e3*Math.pow(2,m),3e4);if(m>=5)return void l(h);i.set(h,m+1);const g=c.get(h);g&&clearTimeout(g);const p=setTimeout(async()=>{const n=t.get(h);if(n){try{n.close()}catch(e){}t.delete(h)}try{const n=s(h);t.set(h,n),a&&a.getTracks().forEach(e=>o(n,e,a));const i=await n.createOffer();await n.setLocalDescription(i);const c=e.getState();r({type:"OFFER",from:c.userId,to:h,offer:n.localDescription})}catch(e){console.error("[WebRTCManager] Reconnection failed:",e),d(h)}},u);c.set(h,p)},clear:l}}({stateManager:this.stateManager,peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,localStream:()=>this.localStream,createPeer:null,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:a}),r=function({stateManager:e,sendSignal:t,remoteStreams:n,remoteVideos:a,addRemoteVideo:s,attemptReconnection:r,clearReconnection:o,removeRemoteVideo:i,peersThatLeft:c}){return function(l){const d=e.getState(),h=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]}]});return h.onicecandidate=e=>{e.candidate&&(console.log("[PeerConnection] ICE candidate for peer:",l,e.candidate),t({type:"ICE_CANDIDATE",from:d.userId,to:l,candidate:e.candidate}))},h.ontrack=e=>{console.log("[PeerConnection] ontrack fired for peer:",l,"track:",e.track,"streams:",e.streams);let t=e.streams&&e.streams[0]||n.get(l);if(t||(console.log("[PeerConnection] Creating new MediaStream for peer:",l),t=new MediaStream,n.set(l,t)),e.track){console.log("[PeerConnection] Adding track to stream:",e.track.kind,e.track.id);try{t.addTrack(e.track)}catch(e){console.warn("[PeerConnection] Error adding track:",e)}}a.has(l)||(console.log("[PeerConnection] Adding remote video for peer:",l,"stream tracks:",t.getTracks().length),s(l,t))},h.onconnectionstatechange=()=>{console.log("[PeerConnection] Connection state changed for peer:",l,"â†’",h.connectionState),"connected"===h.connectionState?o(l):"disconnected"===h.connectionState||"failed"===h.connectionState?c.has(l)?(i(l),o(l)):(i(l),r(l)):"closed"===h.connectionState&&(i(l),o(l))},h}}({stateManager:this.stateManager,sendSignal:e=>this._sendSignal(e),remoteStreams:this.remoteStreams,remoteVideos:this.remoteVideos,addRemoteVideo:n.add,attemptReconnection:s.attempt,clearReconnection:s.clear,removeRemoteVideo:e=>{n.remove(e),this.remoteStreams.delete(e)},peersThatLeft:this.peersThatLeft});s.createPeer=r,this.reconnectionManager=s,this.createPeer=r,this.videoManager=n,this.signalingHandlers=function({getState:e,peerConnections:t,peersThatLeft:n,getLocalStream:a,createPeer:s,sendSignal:r,addOrReplaceTrack:o,clearReconnection:i,removeRemoteVideo:c}){return{async handleJoin(i){console.log("[WebRTCManager] Handling JOIN from",i);const c=e();if(i!==c.userId&&(n.delete(i),!t.has(i)))try{const e=s(i);t.set(i,e);const n=a();n&&n.getTracks().forEach(t=>o(e,t,n));const l=await e.createOffer();await e.setLocalDescription(l),r({type:"OFFER",from:c.userId,to:i,offer:e.localDescription})}catch(e){console.error("[WebRTCManager] Error handling JOIN:",e),t.delete(i)}},async handleOffer(n,i){console.log("[WebRTCManager] Handling OFFER from",n);const c=e();if(n===c.userId)return;let l=t.get(n);if(l&&"closed"!==l.signalingState){try{l.close()}catch(e){}t.delete(n),l=null}l||(l=s(n),t.set(n,l));try{await l.setRemoteDescription(new RTCSessionDescription(i));const e=a();e&&e.getTracks().forEach(t=>o(l,t,e));const t=await l.createAnswer();await l.setLocalDescription(t),r({type:"ANSWER",from:c.userId,to:n,answer:l.localDescription})}catch(e){console.error("[WebRTCManager] Error handling offer:",e),t.delete(n);try{l.close()}catch(e){}}},async handleAnswer(e,n){console.log("[WebRTCManager] Handling ANSWER from",e);const a=t.get(e);if(a&&"have-local-offer"===a.signalingState)try{await a.setRemoteDescription(new RTCSessionDescription(n))}catch(e){console.error("[WebRTCManager] Error handling answer:",e)}},async handleIceCandidate(e,n){console.log("[WebRTCManager] Handling ICE_CANDIDATE from",e);const a=t.get(e);if(a)try{await a.addIceCandidate(new RTCIceCandidate(n))}catch(e){console.warn("[WebRTCManager] Error adding ICE candidate",e)}},handleLeave(e){console.log("[WebRTCManager] Handling LEAVE from",e),n.add(e);const a=t.get(e);if(a){try{a.close()}catch(e){}t.delete(e)}i(e),c(e)}}}({getState:()=>this.stateManager.getState(),peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,getLocalStream:()=>this.localStream,createPeer:r,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:a,clearReconnection:s.clear,removeRemoteVideo:e=>{n.remove(e),this.remoteStreams.delete(e)}})}setLocalStream(e){this.localStream=e}getLocalStream(){return this.localStream}onLocalStreamAvailable(e){this.localStream=e,this.peerConnections.forEach(t=>{try{e.getTracks().forEach(n=>a(t,n,e))}catch(e){}})}async handleSignal(e){if(!e||!e.type)return;const t=e.type,n=e.userId||e.from,a=e.to,s=this.stateManager.getState();a&&a!==s.userId||("JOIN"===t&&n&&n!==s.userId?await this.signalingHandlers.handleJoin(n):"OFFER"===t&&e.offer&&n&&n!==s.userId?await this.signalingHandlers.handleOffer(n,e.offer):"ANSWER"===t&&e.answer&&n&&n!==s.userId?await this.signalingHandlers.handleAnswer(n,e.answer):"ICE_CANDIDATE"===t&&e.candidate&&n&&n!==s.userId?await this.signalingHandlers.handleIceCandidate(n,e.candidate):"LEAVE"===t&&n&&this.signalingHandlers.handleLeave(n))}attemptReconnection(e){return this.reconnectionManager.attempt(e)}_sendSignal(e){this.stateManager.safeSendMessage({type:"SIGNAL_SEND",message:e},function(){})}clearAll(){this.peerConnections.forEach(e=>{try{e.close()}catch(e){}}),this.peerConnections.clear(),this.peersThatLeft.clear(),this.remoteVideos.forEach(e=>{try{e.srcObject&&(e.srcObject=null)}catch(e){}e.remove()}),this.remoteVideos.clear(),this.remoteStreams.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}}(s,r),l=new class{constructor(e){this.stateManager=e,this.urlMonitorInterval=null,this.lastUrl=null}start(){this.lastUrl=window.location.href}stop(){this.urlMonitorInterval&&(clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=null)}saveState(){const e=this.stateManager.getState();if(!e.partyActive)return;const t=this.getRestorationState()||{},n={roomId:e.roomId,currentTime:t.currentTime||null,isPlaying:"boolean"==typeof t.isPlaying?t.isPlaying:null,timestamp:Date.now()};sessionStorage.setItem("toperparty_restore",JSON.stringify(n))}clearState(){sessionStorage.removeItem("toperparty_restore")}getRestorationState(){const e=sessionStorage.getItem("toperparty_restore");if(!e)return null;try{const t=JSON.parse(e);if(Date.now()-t.timestamp<3e4)return t}catch(e){console.error("[toperparty] Failed to parse restoration state:",e)}return null}}(s);console.log("[Content Script] Managers initialized");let d=null;!function(){const e=l.getRestorationState();e&&(l.clearState(),s.setRestoringFlag(!0),setTimeout(function(){chrome.runtime.sendMessage({type:"RESTORE_PARTY",roomId:e.roomId}),setTimeout(function(){s.setRestoringFlag(!1)},2e3)},1e3))}(),chrome.runtime.onMessage.addListener((e,t,n)=>{if(console.log("[Content Script] Received message:",e.type),"REQUEST_MEDIA_STREAM"===e.type)return navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{d=e,c.setLocalStream(e),c.onLocalStreamAvailable(e),n({success:!0})}).catch(e=>n({success:!1,error:e.message})),!0;"PARTY_STARTED"===e.type&&(console.log("[Content Script] Party started:",e.userId,e.roomId),s.startParty(e.userId,e.roomId),i.setup(),l.start(),n({success:!0})),"PARTY_STOPPED"===e.type&&(s.stopParty(),i.teardown(),l.stop(),l.clearState(),c.clearAll(),d&&(d.getTracks().forEach(e=>e.stop()),d=null),n({success:!0})),"SIGNAL"===e.type&&(console.log("[Content Script] Handling SIGNAL:",e.message?.type),c.handleSignal(e.message)),"APPLY_PLAYBACK_CONTROL"===e.type&&i.handlePlaybackControl(e.control,e.fromUserId),"APPLY_SYNC_PLAYBACK"===e.type&&i.handlePassiveSync(e.currentTime,e.isPlaying,e.fromUserId,e.timestamp),"APPLY_SEEK"===e.type&&i.handleSeek(e.currentTime,e.isPlaying,e.fromUserId),"APPLY_URL_CHANGE"===e.type&&(s.restoringPartyState||(window.location.href=e.url)),"HANDLE_REQUEST_SYNC"===e.type&&i.handleRequestSync(e.fromUserId),"APPLY_SYNC_RESPONSE"===e.type&&i.handleSyncResponse(e.currentTime,e.isPlaying,e.fromUserId)}),window.addEventListener("beforeunload",()=>{s.isActive()&&l.saveState()})})();
//# sourceMappingURL=content-script.js.map