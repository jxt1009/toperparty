(()=>{"use strict";const e=new class{constructor(){this.partyActive=!1,this.userId=null,this.roomId=null,this.restoringPartyState=!1,this.lastLocalAction={type:null,time:0},this.lastRemoteAction={type:null,time:0}}startParty(e,t){this.partyActive=!0,this.userId=e,this.roomId=t,console.log("Party started! Room:",t,"User:",e)}stopParty(){this.partyActive=!1,this.userId=null,this.roomId=null,this.lastLocalAction={type:null,time:0},this.lastRemoteAction={type:null,time:0},console.log("Party stopped")}isActive(){return this.partyActive}getUserId(){return this.userId}getRoomId(){return this.roomId}getState(){return{partyActive:this.partyActive,userId:this.userId,roomId:this.roomId,restoringPartyState:this.restoringPartyState}}setRestoringFlag(e){this.restoringPartyState=e}isEcho(e){const t=Date.now()-this.lastLocalAction.time;return this.lastLocalAction.type===e&&t<500&&(console.log(`Ignoring echo of ${e} (${t}ms ago)`),!0)}recordLocalAction(e){this.lastLocalAction={type:e,time:Date.now()},console.log(`Recorded local action: ${e}`)}recordRemoteAction(e){this.lastRemoteAction={type:e,time:Date.now()},console.log(`Recorded remote action: ${e}`)}getTimeSinceLocalAction(){return Date.now()-this.lastLocalAction.time}getTimeSinceRemoteAction(){return Date.now()-this.lastRemoteAction.time}isExtensionContextValid(){try{return chrome.runtime&&chrome.runtime.id}catch(e){return!1}}safeSendMessage(e,t){if(this.isExtensionContextValid())try{chrome.runtime.sendMessage(e,t)}catch(e){console.warn("Failed to send message, extension may have been reloaded:",e.message)}else console.warn("Extension context invalidated - please reload the page")}},t=new class{constructor(){this.injectAPIBridge()}injectAPIBridge(){const e=document.createElement("script");e.src=chrome.runtime.getURL("netflix-api-bridge.js"),(document.head||document.documentElement).appendChild(e),e.onload=function(){console.log("Netflix API bridge loaded"),e.remove()}}_sendCommand(e,t=[]){return new Promise(function(o){const n=function(t){t.detail.command===e&&(document.removeEventListener("__toperparty_response",n),o(t.detail.result))};document.addEventListener("__toperparty_response",n),setTimeout(function(){o(null)},1e3),document.dispatchEvent(new CustomEvent("__toperparty_command",{detail:{command:e,args:t}}))})}play(){return this._sendCommand("play")}pause(){return this._sendCommand("pause")}seek(e){return this._sendCommand("seek",[e])}getCurrentTime(){return this._sendCommand("getCurrentTime")}isPaused(){return this._sendCommand("isPaused")}getVideoElement(){return document.querySelector("video")}},o=new class{constructor(e,t){this.state=e,this.netflix=t,this.listeners=null,this.syncInterval=null}async setup(){try{const e=await this.waitForVideo();if(!e)return void console.warn("Netflix video element not found after wait");this.attachEventListeners(e),this.startPeriodicSync(e),this.sendInitialSync(e),console.log("Playback sync setup complete")}catch(e){console.error("Error setting up playback sync:",e)}}waitForVideo(){return new Promise((e,t)=>{const o=setTimeout(()=>t(new Error("Video element timeout")),1e4),n=()=>{const t=this.netflix.getVideoElement();t?(clearTimeout(o),e(t)):setTimeout(n,100)};n()})}attachEventListeners(e){const t=()=>{this.state.isActive()&&(this.state.isEcho("play")||(console.log("Local play - broadcasting to peers"),this.state.recordLocalAction("play"),this.state.safeSendMessage({type:"PLAY_PAUSE",control:"play",timestamp:e.currentTime})))},o=()=>{this.state.isActive()&&(this.state.isEcho("pause")||(console.log("Local pause - broadcasting to peers"),this.state.recordLocalAction("pause"),this.state.safeSendMessage({type:"PLAY_PAUSE",control:"pause",timestamp:e.currentTime})))},n=()=>{this.state.isActive()&&(this.state.isEcho("seek")||(console.log("Local seek to",e.currentTime,"- broadcasting to peers"),this.state.recordLocalAction("seek"),this.state.safeSendMessage({type:"SEEK",currentTime:e.currentTime,isPlaying:!e.paused})))};let s=0;const r=()=>{if(!this.state.isActive())return;const t=Date.now();t-s<1e3||(s=t,this.state.safeSendMessage({type:"SYNC_TIME",currentTime:e.currentTime,isPlaying:!e.paused}))};e.addEventListener("play",t),e.addEventListener("pause",o),e.addEventListener("seeked",n),e.addEventListener("timeupdate",r),this.listeners={onPlay:t,onPause:o,onSeeked:n,onTimeUpdate:r,video:e}}startPeriodicSync(e){this.syncInterval=setInterval(()=>{this.state.isActive()&&e&&this.state.safeSendMessage({type:"SYNC_TIME",currentTime:e.currentTime,isPlaying:!e.paused})},5e3)}sendInitialSync(e){setTimeout(()=>{this.state.isActive()&&e&&(console.log("Sending initial sync after video setup"),this.state.safeSendMessage({type:"SYNC_TIME",currentTime:e.currentTime,isPlaying:!e.paused}))},2e3)}teardown(){if(this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null),this.listeners&&this.listeners.video){const{video:e,onPlay:t,onPause:o,onSeeked:n,onTimeUpdate:s}=this.listeners;try{e.removeEventListener("play",t),e.removeEventListener("pause",o),e.removeEventListener("seeked",n),e.removeEventListener("timeupdate",s)}catch(e){console.warn("Error removing video event listeners:",e)}this.listeners=null}}async handlePlaybackControl(e,t){console.log("Applying remote",e,"command from",t),this.state.recordRemoteAction(e);try{"play"===e?(await this.netflix.play(),console.log("Remote play completed"),this.state.recordLocalAction("play")):"pause"===e&&(await this.netflix.pause(),console.log("Remote pause completed"),this.state.recordLocalAction("pause"))}catch(t){console.error("Failed to apply remote",e,":",t)}}async handleSeek(e,t,o){console.log("Applying remote SEEK to",e,"s from",o),this.state.recordRemoteAction("seek");const n=1e3*e;try{await this.netflix.seek(n),console.log("Remote seek completed"),this.state.recordLocalAction("seek");const e=await this.netflix.isPaused();t&&e?(await this.netflix.play(),this.state.recordLocalAction("play")):t||e||(await this.netflix.pause(),this.state.recordLocalAction("pause"))}catch(e){console.error("Failed to apply remote seek:",e)}}async handlePassiveSync(e,t,o){try{const o=await this.netflix.getCurrentTime(),n=1e3*e,s=Math.abs(o-n),r=this.state.getTimeSinceLocalAction();if(r<1e3)return void console.log("Ignoring passive sync - recent local action:",this.state.lastLocalAction.type,r,"ms ago");s>2e3&&(console.log("Passive sync: diff was",(s/1e3).toFixed(1),"s - correcting"),await this.netflix.seek(n),this.state.recordLocalAction("seek"));const a=await this.netflix.isPaused();t&&a&&r>1e3?(console.log("Passive sync: resuming playback"),await this.netflix.play(),this.state.recordLocalAction("play")):!t&&!a&&r>1e3&&(console.log("Passive sync: pausing playback"),await this.netflix.pause(),this.state.recordLocalAction("pause"))}catch(e){console.error("Error handling passive sync:",e)}}}(e,t),n=new class{constructor(e){this.state=e,this.peerConnections=new Map,this.reconnectionAttempts=new Map,this.reconnectionTimeouts=new Map,this.localStream=null}setLocalStream(e){this.localStream=e}getLocalStream(){return this.localStream}getPeerConnections(){return this.peerConnections}getReconnectionAttempts(){return this.reconnectionAttempts}getReconnectionTimeouts(){return this.reconnectionTimeouts}clearAll(){this.peerConnections.forEach(e=>{try{e.close()}catch(e){}}),this.peerConnections.clear(),this.reconnectionTimeouts.forEach(e=>{clearTimeout(e)}),this.reconnectionTimeouts.clear(),this.reconnectionAttempts.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}},s=new class{constructor(){this.localPreviewVideo=null,this.remoteVideos=new Map,this.remoteStreams=new Map,this.streamMonitorInterval=null}getRemoteVideos(){return this.remoteVideos}getRemoteStreams(){return this.remoteStreams}setLocalPreviewVideo(e){this.localPreviewVideo=e}getLocalPreviewVideo(){return this.localPreviewVideo}setStreamMonitorInterval(e){this.streamMonitorInterval=e}getStreamMonitorInterval(){return this.streamMonitorInterval}clearStreamMonitorInterval(){this.streamMonitorInterval&&(clearInterval(this.streamMonitorInterval),this.streamMonitorInterval=null)}clearAll(){this.localPreviewVideo=null,this.remoteVideos.clear(),this.remoteStreams.clear(),this.clearStreamMonitorInterval()}},r=new class{constructor(e){this.stateManager=e,this.urlMonitorInterval=null,this.lastUrl=null}start(){this.lastUrl=window.location.href}stop(){this.urlMonitorInterval&&(clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=null)}saveState(){const e=this.stateManager.getState();e.partyActive&&sessionStorage.setItem("toperparty_restore",JSON.stringify({userId:e.userId,roomId:e.roomId,timestamp:Date.now()}))}clearState(){sessionStorage.removeItem("toperparty_restore")}getRestorationState(){const e=sessionStorage.getItem("toperparty_restore");if(!e)return null;try{const t=JSON.parse(e);if(Date.now()-t.timestamp<3e4)return t}catch(e){console.error("[toperparty] Failed to parse restoration state:",e)}return null}}(e);let a=null;const i=n.peerConnections,c=s.getRemoteVideos(),l=s.getRemoteStreams(),d=n.reconnectionAttempts,m=n.reconnectionTimeouts;!function(){const t=r.getRestorationState();t&&(console.log("Detected party state after navigation, will restore:",t),r.clearState(),e.setRestoringFlag(!0),setTimeout(function(){chrome.runtime.sendMessage({type:"RESTORE_PARTY",roomId:t.roomId,userId:t.userId}),setTimeout(function(){e.setRestoringFlag(!1),console.log("Party restoration complete, URL monitoring active")},2e3)},1e3))}(),t.injectAPIBridge();let u=window.location.href;function h(e,t,o){const n=e.getSenders().find(e=>e.track&&e.track.kind===t.kind);if(n)n.replaceTrack(t).catch(e=>console.warn("Error replacing track",e));else try{e.addTrack(t,o)}catch(e){console.warn("Error adding track",e)}}function p(t){e.safeSendMessage({type:"SIGNAL_SEND",message:t},function(e){})}async function g(t){const o=e.getState();if(!o.partyActive||!o.userId||!o.roomId)return void console.log("Cannot reconnect - party not active");const n=d.get(t)||0,s=Math.min(1e3*Math.pow(2,n),3e4);if(n>=5)return console.log("Max reconnection attempts reached for",t),d.delete(t),void m.delete(t);console.log(`Attempting reconnection to ${t} (attempt ${n+1}/5) in ${s}ms`),d.set(t,n+1);const r=m.get(t);r&&clearTimeout(r);const c=setTimeout(async function(){console.log("Reconnecting to",t);const e=i.get(t);if(e){try{e.close()}catch(e){console.warn("Error closing old peer connection:",e)}i.delete(t)}try{const e=f(t);i.set(t,e),a&&a.getTracks().forEach(t=>h(e,t,a));const n=await e.createOffer();await e.setLocalDescription(n),p({type:"OFFER",from:o.userId,to:t,offer:e.localDescription}),console.log("Reconnection offer sent to",t)}catch(e){console.error("Failed to create reconnection offer:",e),g(t)}},s);m.set(t,c)}function y(e){d.delete(e);const t=m.get(e);t&&(clearTimeout(t),m.delete(e))}function f(t){const o=e.getState(),n=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]}]});return n.onicecandidate=e=>{e.candidate&&p({type:"ICE_CANDIDATE",from:o.userId,to:t,candidate:e.candidate})},n.ontrack=e=>{console.log("Received remote track from",t,"track=",e.track&&e.track.kind);let o=e.streams&&e.streams[0]||l.get(t);if(o||(o=new MediaStream,l.set(t,o)),e.track)try{o.addTrack(e.track),e.track.onended=function(){console.warn("Remote track ended from",t,"kind=",e.track.kind)},console.log("Added remote track to stream, kind=",e.track.kind,"readyState=",e.track.readyState)}catch(e){console.warn("Failed to add remote track to stream",e)}c.has(t)||function(e,t){v(e);const o=document.createElement("video");o.id="toperparty-remote-"+e,o.autoplay=!0,o.playsInline=!0,o.muted=!0,o.style.position="fixed",o.style.bottom="20px",o.style.right=20+180*c.size+"px",o.style.width="240px",o.style.height="160px",o.style.zIndex=10001,o.style.border="2px solid #00aaff",o.style.borderRadius="4px";const n=t.getAudioTracks();console.log("Remote stream audio tracks:",n.length),n.forEach(function(e){console.log("Audio track:",e.id,"enabled=",e.enabled,"readyState=",e.readyState)});try{o.srcObject=t}catch(e){o.src=URL.createObjectURL(t)}document.body.appendChild(o),c.set(e,o);try{o.play().then(function(){console.log("Remote video playing, unmuting audio for",e),o.muted=!1,o.volume=1}).catch(function(e){console.warn("Remote video play() failed:",e),o.muted=!1})}catch(e){console.error("Exception calling play():",e)}}(t,o)},n.onconnectionstatechange=()=>{console.log("PC state",n.connectionState,"for",t),"connected"===n.connectionState?(console.log("Connection established successfully with",t),y(t)):"disconnected"===n.connectionState||"failed"===n.connectionState?(console.warn("Connection",n.connectionState,"with",t,"- attempting reconnection"),i.delete(t),v(t),g(t)):"closed"===n.connectionState&&(console.log("Connection closed with",t),i.delete(t),v(t),y(t))},n}function v(e){const t=c.get(e);if(t){try{t.srcObject&&(t.srcObject=null)}catch(e){}t.remove(),c.delete(e)}l.delete(e)}chrome.runtime.onMessage.addListener((t,l,g)=>{if("SIGNAL"===t.type&&t.message)(async function(t){if(!t||!t.type)return;const o=t.type,n=t.userId||t.from,s=t.to,r=e.getState();if(!s||s===r.userId)if("JOIN"===o&&n&&n!==r.userId){if(!i.has(n))try{const e=f(n);i.set(n,e),a&&a.getTracks().forEach(t=>h(e,t,a));const t=await e.createOffer();await e.setLocalDescription(t),p({type:"OFFER",from:r.userId,to:n,offer:e.localDescription})}catch(e){console.error("Error handling JOIN and creating offer:",e),i.delete(n)}}else{if("OFFER"===o&&t.offer&&n&&n!==r.userId){let e=i.get(n);if(e){const t=e.signalingState;if("stable"!==t&&"closed"!==t){console.warn("Received offer while in signaling state:",t,"- recreating connection");try{e.close()}catch(e){}i.delete(n),e=null}}e||(e=f(n),i.set(n,e));try{await e.setRemoteDescription(new RTCSessionDescription(t.offer)),a&&a.getTracks().forEach(t=>h(e,t,a));const o=await e.createAnswer();await e.setLocalDescription(o),p({type:"ANSWER",from:r.userId,to:n,answer:e.localDescription})}catch(t){console.error("Error handling offer:",t),i.delete(n);try{e.close()}catch(e){}}return}if("ANSWER"===o&&t.answer&&n&&n!==r.userId){const e=i.get(n);if(e)try{"have-local-offer"===e.signalingState?await e.setRemoteDescription(new RTCSessionDescription(t.answer)):console.warn("Received answer in unexpected state:",e.signalingState)}catch(e){console.error("Error handling answer:",e)}return}if("ICE_CANDIDATE"===o&&t.candidate&&n&&n!==r.userId){const e=i.get(n);if(e)try{await e.addIceCandidate(new RTCIceCandidate(t.candidate))}catch(e){console.warn("Error adding received ICE candidate",e)}return}if("LEAVE"===o&&n){const e=i.get(n);return e&&(e.close(),i.delete(n)),void v(n)}}})(t.message).catch(e=>console.error("Signal handling error:",e));else{if("REQUEST_MEDIA_STREAM"===t.type)return navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}},audio:!0}).then(e=>{a=e,n.setLocalStream(e),console.log("Media stream obtained in content script"),e.getTracks().forEach(function(e){console.log("Local stream track obtained:",e.kind,"id=",e.id,"readyState=",e.readyState),e.onended=function(){console.error("LOCAL STREAM TRACK ENDED UNEXPECTEDLY:",e.kind,"id=",e.id)},e.onmute=function(){console.warn("Local stream track muted:",e.kind)},e.onunmute=function(){console.log("Local stream track unmuted:",e.kind)}}),function(e){let t=s.getLocalPreviewVideo();if(t){try{t.srcObject&&(t.srcObject=null)}catch(e){}t.remove(),t=null}const o=document.createElement("video");o.id="toperparty-local-preview",o.autoplay=!0,o.muted=!0,o.playsInline=!0,o.style.position="fixed",o.style.bottom="20px",o.style.left="20px",o.style.width="240px",o.style.height="160px",o.style.zIndex=10001,o.style.border="2px solid #e50914",o.style.borderRadius="4px",o.style.transform="scaleX(-1)";try{o.srcObject=e}catch(t){o.src=URL.createObjectURL(e)}document.body.appendChild(o),s.setLocalPreviewVideo(o),o.play().catch(function(e){console.warn("Local preview play() failed (this is usually fine):",e)})}(e),function(e){s.clearStreamMonitorInterval();const t=setInterval(function(){if(!e)return console.warn("Local stream is null, stopping monitor"),void s.clearStreamMonitorInterval();const t=e.getTracks();if(0===t.length)return console.warn("Local stream has no tracks"),void s.clearStreamMonitorInterval();let o=!0;t.forEach(function(e){"live"!==e.readyState&&(console.error("Local stream track not live:",e.kind,"readyState=",e.readyState),o=!1)}),o||console.warn("Some local stream tracks are not active - may need to restart stream")},5e3);s.setStreamMonitorInterval(t)}(e),i.forEach(t=>{try{e.getTracks().forEach(o=>h(t,o,e))}catch(e){console.warn("Error adding tracks to pc",e)}}),g({success:!0,message:"Media stream obtained"})}).catch(e=>{console.error("Failed to get media stream:",e),g({success:!1,error:e.message})}),!0;if("PARTY_STARTED"===t.type&&(e.startParty(t.userId,t.roomId),console.log("Party started! Room:",t.roomId,"User:",t.userId),function(){const t=e.getState();window.addEventListener("beforeunload",function(){t.partyActive&&t.userId&&t.roomId&&r.saveState()}),setInterval(function(){const t=window.location.href,o=e.getState();t!==u&&o.partyActive&&!o.restoringPartyState?(console.log("URL changed from",u,"to",t),u=t,e.safeSendMessage({type:"URL_CHANGE",url:t})):o.restoringPartyState||(u=t)},500)}(),o.setup(),g({success:!0})),"PARTY_STOPPED"===t.type){e.stopParty(),u=window.location.href,r.stop(),o.teardown(),s.clearStreamMonitorInterval(),a&&(a.getTracks().forEach(e=>e.stop()),a=null,n.setLocalStream(null)),function(){const e=s.getLocalPreviewVideo();if(e){try{e.srcObject&&(e.srcObject.getTracks().forEach(function(e){e.stop()}),e.srcObject=null)}catch(e){console.warn("Error stopping local preview tracks:",e)}e.remove(),s.setLocalPreviewVideo(null)}}(),function(){const e=document.getElementById("netflix-party-controls");e&&e.remove()}(),m.forEach(e=>{clearTimeout(e)}),m.clear(),d.clear();try{i.forEach(e=>{try{e.close()}catch(e){}}),i.clear()}catch(e){}try{c.forEach((e,t)=>v(t))}catch(e){}console.log("Party stopped"),g({success:!0})}if("APPLY_PLAYBACK_CONTROL"===t.type&&(o.handlePlaybackControl(t),g({success:!0})),"APPLY_SYNC_PLAYBACK"===t.type&&(o.handlePassiveSync(t),g({success:!0})),"APPLY_SEEK"===t.type&&(o.handleSeek(t),g({success:!0})),"APPLY_URL_CHANGE"===t.type){console.log("Applying URL change from remote user:",t.url,"from user:",t.fromUserId);const o=e.getState();o.partyActive&&o.userId&&o.roomId&&(r.saveState(),console.log("Saved party state before navigation")),window.location.href=t.url,g({success:!0})}}})})();
//# sourceMappingURL=content-script.js.map