(()=>{"use strict";class e{constructor(){this.suppressLocalUntil=0}set(e){this.suppressLocalUntil=Date.now()+e}isActive(){return Date.now()<this.suppressLocalUntil}}class t{constructor(e=200){this.delayMs=e,this.timer=null,this.events=new Set}add(e){this.events.add(e)}schedule(e){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=this.events;this.events=new Set,this.timer=null,e(t)},this.delayMs)}cancel(){this.timer&&clearTimeout(this.timer),this.timer=null,this.events.clear()}}class a{constructor(e){this.value=e}get(){return this.value}set(e){this.value=e}}function s(e,t,a){const s=e.getSenders().find(e=>e.track&&e.track.kind===t.kind);if(s)s.replaceTrack(t).catch(e=>console.warn("[WebRTCManager] Error replacing track",e));else try{e.addTrack(t,a)}catch(e){}}const n=new class{constructor(){this.partyActive=!1,this.userId=null,this.roomId=null,this.restoringPartyState=!1}startParty(e,t){this.partyActive=!0,this.userId=e,this.roomId=t}stopParty(){this.partyActive=!1,this.userId=null,this.roomId=null}isActive(){return this.partyActive}getUserId(){return this.userId}getRoomId(){return this.roomId}getState(){return{partyActive:this.partyActive,userId:this.userId,roomId:this.roomId,restoringPartyState:this.restoringPartyState}}isInParty(){return!!(this.partyActive&&this.userId&&this.roomId)}setRestoringFlag(e){this.restoringPartyState=e}isExtensionContextValid(){try{return chrome.runtime&&chrome.runtime.id}catch{return!1}}safeSendMessage(e,t){if(this.isExtensionContextValid())try{chrome.runtime.sendMessage(e,t)}catch(e){console.warn("Failed to send message:",e.message)}}},r=new class{constructor(){this.localPreviewVideo=null,this.remoteVideos=new Map,this.remoteStreams=new Map,this.streamMonitorInterval=null}getRemoteVideos(){return this.remoteVideos}getRemoteStreams(){return this.remoteStreams}setLocalPreviewVideo(e){this.localPreviewVideo=e}getLocalPreviewVideo(){return this.localPreviewVideo}setStreamMonitorInterval(e){this.streamMonitorInterval=e}getStreamMonitorInterval(){return this.streamMonitorInterval}clearStreamMonitorInterval(){this.streamMonitorInterval&&(clearInterval(this.streamMonitorInterval),this.streamMonitorInterval=null)}clearAll(){this.localPreviewVideo=null,this.remoteVideos.clear(),this.remoteStreams.clear(),this.clearStreamMonitorInterval()}},i=new class{constructor(){this.injectAPIBridge()}injectAPIBridge(){const e=document.createElement("script");e.src=chrome.runtime.getURL("netflix-api-bridge.js"),(document.head||document.documentElement).appendChild(e),e.onload=function(){e.remove()}}_sendCommand(e,t=[]){return new Promise(function(a){const s=function(t){t.detail.command===e&&(document.removeEventListener("__toperparty_response",s),a(t.detail.result))};document.addEventListener("__toperparty_response",s),setTimeout(function(){a(null)},1e3),document.dispatchEvent(new CustomEvent("__toperparty_command",{detail:{command:e,args:t}}))})}play(){return this._sendCommand("play")}pause(){return this._sendCommand("pause")}seek(e){return this._sendCommand("seek",[e])}getCurrentTime(){return this._sendCommand("getCurrentTime")}isPaused(){return this._sendCommand("isPaused")}getVideoElement(){return document.querySelector("video")}},o=new class{constructor(s,n){this.state=s,this.netflix=n,this.lock=new e,this.debouncer=new t(200),this.isInitializedRef=new a(!1),this.listeners=null,this.contextRef=new a({lastUserInteractionAt:0}),this.remote=function({state:e,netflix:t,lock:a,isInitializedRef:s,contextRef:n}){async function r(e,t,s){a.set(t);try{await s()}catch(t){console.error(`[SyncManager] Error applying remote ${e}:`,t)}}return{async handleRequestSync(a){if(s.get())try{const s=await t.getCurrentTime(),n=await t.isPaused();e.safeSendMessage({type:"SYNC_RESPONSE",targetUserId:a,currentTime:s/1e3,isPlaying:!n})}catch(e){console.error("[SyncManager] Error handling sync request:",e)}},async handleSyncResponse(e,a,n){s.get()||(s.set(!0),await r("initial-sync",2e3,async()=>{await t.seek(1e3*e);const s=await t.isPaused();a&&s?await t.play():a||s||await t.pause()}))},async handlePlaybackControl(e){await r(e,1e3,async()=>{"play"===e?await t.play():await t.pause()})},async handleSeek(e,a){await r("seek",2e3,async()=>{await t.seek(1e3*e);const s=await t.isPaused();a&&s?await t.play():a||s||await t.pause()})},async handlePassiveSync(e,s,i,o){const c=Date.now();if(!(o&&c-o>5e3||c-n.get().lastUserInteractionAt<1e4||a.isActive()))try{const a=await t.getCurrentTime(),n=1e3*e;if(Math.abs(a-n)<=3e3)return;await r("passive-correction",1500,async()=>{await t.seek(n);const e=await t.isPaused();s&&e?await t.play():s||e||await t.pause()})}catch(e){console.error("[SyncManager] Error handling passive sync:",e)}}}}({state:this.state,netflix:this.netflix,lock:this.lock,isInitializedRef:this.isInitializedRef,contextRef:this.contextRef})}async setup(){try{const e=await this.waitForVideo();if(!e)return void console.warn("[SyncManager] Netflix video element not found");this.isInitializedRef.set(!1),this.state.safeSendMessage({type:"REQUEST_SYNC"}),setTimeout(()=>{this.isInitializedRef.get()||this.isInitializedRef.set(!0)},2e3);const t=function({video:e,state:t,isInitializedRef:a,lock:s,debouncer:n,onBroadcast:r,onPassiveSyncContext:i}){const o={lastUserInteractionAt:0},c=i=>{t.isActive()&&a.get()&&(s.isActive()||(o.lastUserInteractionAt=Date.now(),n.add(i.type),n.schedule(()=>r(e))))};let l=0;const d=()=>{if(!t.isActive())return;const a=Date.now();s.isActive()||a-o.lastUserInteractionAt<5e3||a-l<1e4||e.paused||(l=a,i({now:a,lastPassiveSentAt:l}))};return e.addEventListener("play",c),e.addEventListener("pause",c),e.addEventListener("seeked",c),e.addEventListener("timeupdate",d),{video:e,handleLocalEvent:c,handleTimeUpdate:d,context:o}}({video:e,state:this.state,isInitializedRef:this.isInitializedRef,lock:this.lock,debouncer:this.debouncer,onBroadcast:e=>this.broadcastLocalState(e),onPassiveSyncContext:({now:t})=>{this.state.safeSendMessage({type:"SYNC_TIME",currentTime:e.currentTime,isPlaying:!e.paused,timestamp:t})}});this.listeners=t,this.contextRef.set(t.context)}catch(e){console.error("[SyncManager] Error setting up playback sync:",e)}}teardown(){if(this.listeners&&this.listeners.video){const{video:e,handleLocalEvent:t,handleTimeUpdate:a}=this.listeners;try{e.removeEventListener("play",t),e.removeEventListener("pause",t),e.removeEventListener("seeked",t),e.removeEventListener("timeupdate",a)}catch(e){console.warn("[SyncManager] Error removing listeners:",e)}this.listeners=null}this.debouncer.cancel()}waitForVideo(){return new Promise((e,t)=>{const a=setTimeout(()=>t(new Error("Video element timeout")),1e4),s=()=>{const t=this.netflix.getVideoElement();t?(clearTimeout(a),e(t)):setTimeout(s,100)};s()})}broadcastLocalState(e){const t=e.currentTime,a=!e.paused,s=new Set(this.debouncer.events);if(s.has("seeked"))this.state.safeSendMessage({type:"SEEK",currentTime:t,isPlaying:a});else if(s.has("play")||s.has("pause")){const e=a?"play":"pause";this.state.safeSendMessage({type:"PLAY_PAUSE",control:e,timestamp:t})}}handleRequestSync(e){return this.remote.handleRequestSync(e)}handleSyncResponse(e,t,a){return this.remote.handleSyncResponse(e,t,a)}handlePlaybackControl(e,t){return this.remote.handlePlaybackControl(e,t)}handleSeek(e,t,a){return this.remote.handleSeek(e,t,a)}handlePassiveSync(e,t,a,s){return this.remote.handlePassiveSync(e,t,a,s)}}(n,i),c=new class{constructor(e,t){this.stateManager=e,this.uiManager=t,this.peerConnections=new Map,this.remoteStreams=this.uiManager.getRemoteStreams(),this.remoteVideos=this.uiManager.getRemoteVideos(),this.peersThatLeft=new Set,this.localStream=null;const a=function(e){function t(t){const a=e.get(t);if(a){try{a.srcObject&&(a.srcObject=null)}catch(e){}a.remove(),e.delete(t)}}return{add:function(a,s){t(a);const n=document.createElement("video");n.id="toperparty-remote-"+a,n.autoplay=!0,n.playsInline=!0,n.muted=!0,n.style.position="fixed",n.style.bottom="20px",n.style.right=20+180*e.size+"px",n.style.width="240px",n.style.height="160px",n.style.zIndex=10001,n.style.border="2px solid #00aaff",n.style.borderRadius="4px";try{n.srcObject=s}catch(e){n.src=URL.createObjectURL(s)}document.body.appendChild(n),e.set(a,n);try{n.play().then(()=>{n.muted=!1,n.volume=1}).catch(()=>{n.muted=!1})}catch(e){}},remove:t}}(this.remoteVideos),n=function({stateManager:e,peerConnections:t,peersThatLeft:a,localStream:s,createPeer:n,sendSignal:r,addOrReplaceTrack:i}){const o=new Map,c=new Map;function l(e){o.delete(e);const t=c.get(e);t&&(clearTimeout(t),c.delete(e))}return{attempt:async function d(h){if(!e.isInParty())return;if(a.has(h))return void l(h);const m=o.get(h)||0,u=Math.min(1e3*Math.pow(2,m),3e4);if(m>=5)return void l(h);o.set(h,m+1);const p=c.get(h);p&&clearTimeout(p);const g=setTimeout(async()=>{const a=t.get(h);if(a){try{a.close()}catch(e){}t.delete(h)}try{const a=n(h);t.set(h,a),s&&s.getTracks().forEach(e=>i(a,e,s));const o=await a.createOffer();await a.setLocalDescription(o);const c=e.getState();r({type:"OFFER",from:c.userId,to:h,offer:a.localDescription})}catch(e){console.error("[WebRTCManager] Reconnection failed:",e),d(h)}},u);c.set(h,g)},clear:l}}({stateManager:this.stateManager,peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,localStream:()=>this.localStream,createPeer:null,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:s}),r=function({stateManager:e,sendSignal:t,remoteStreams:a,remoteVideos:s,addRemoteVideo:n,attemptReconnection:r,clearReconnection:i,removeRemoteVideo:o,peersThatLeft:c}){return function(l){const d=e.getState(),h=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]}]});return h.onicecandidate=e=>{e.candidate&&t({type:"ICE_CANDIDATE",from:d.userId,to:l,candidate:e.candidate})},h.ontrack=e=>{let t=e.streams&&e.streams[0]||a.get(l);if(t||(t=new MediaStream,a.set(l,t)),e.track)try{t.addTrack(e.track)}catch(e){}s.has(l)||n(l,t)},h.onconnectionstatechange=()=>{"connected"===h.connectionState?i(l):"disconnected"===h.connectionState||"failed"===h.connectionState?c.has(l)?(o(l),i(l)):(o(l),r(l)):"closed"===h.connectionState&&(o(l),i(l))},h}}({stateManager:this.stateManager,sendSignal:e=>this._sendSignal(e),remoteStreams:this.remoteStreams,remoteVideos:this.remoteVideos,addRemoteVideo:a.add,attemptReconnection:n.attempt,clearReconnection:n.clear,removeRemoteVideo:e=>{a.remove(e),this.remoteStreams.delete(e)},peersThatLeft:this.peersThatLeft});n.createPeer=r,this.reconnectionManager=n,this.createPeer=r,this.videoManager=a,this.signalingHandlers=function({state:e,peerConnections:t,peersThatLeft:a,localStream:s,createPeer:n,sendSignal:r,addOrReplaceTrack:i,clearReconnection:o,removeRemoteVideo:c}){return{async handleJoin(o){if(o!==e.userId&&(a.delete(o),!t.has(o)))try{const a=n(o);t.set(o,a),s&&s.getTracks().forEach(e=>i(a,e,s));const c=await a.createOffer();await a.setLocalDescription(c),r({type:"OFFER",from:e.userId,to:o,offer:a.localDescription})}catch(e){console.error("[WebRTCManager] Error handling JOIN:",e),t.delete(o)}},async handleOffer(a,o){if(a===e.userId)return;let c=t.get(a);if(c&&"closed"!==c.signalingState){try{c.close()}catch(e){}t.delete(a),c=null}c||(c=n(a),t.set(a,c));try{await c.setRemoteDescription(new RTCSessionDescription(o)),s&&s.getTracks().forEach(e=>i(c,e,s));const t=await c.createAnswer();await c.setLocalDescription(t),r({type:"ANSWER",from:e.userId,to:a,answer:c.localDescription})}catch(e){console.error("[WebRTCManager] Error handling offer:",e),t.delete(a);try{c.close()}catch(e){}}},async handleAnswer(e,a){const s=t.get(e);if(s&&"have-local-offer"===s.signalingState)try{await s.setRemoteDescription(new RTCSessionDescription(a))}catch(e){console.error("[WebRTCManager] Error handling answer:",e)}},async handleIceCandidate(e,a){const s=t.get(e);if(s)try{await s.addIceCandidate(new RTCIceCandidate(a))}catch(e){console.warn("[WebRTCManager] Error adding ICE candidate",e)}},handleLeave(e){a.add(e);const s=t.get(e);if(s){try{s.close()}catch(e){}t.delete(e)}o(e),c(e)}}}({state:this.stateManager.getState(),peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,localStream:()=>this.localStream,createPeer:r,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:s,clearReconnection:n.clear,removeRemoteVideo:e=>{a.remove(e),this.remoteStreams.delete(e)}})}setLocalStream(e){this.localStream=e}getLocalStream(){return this.localStream}onLocalStreamAvailable(e){this.localStream=e,this.peerConnections.forEach(t=>{try{e.getTracks().forEach(a=>s(t,a,e))}catch(e){}})}async handleSignal(e){if(!e||!e.type)return;const t=e.type,a=e.userId||e.from,s=e.to,n=this.stateManager.getState();s&&s!==n.userId||("JOIN"===t&&a&&a!==n.userId?await this.signalingHandlers.handleJoin(a):"OFFER"===t&&e.offer&&a&&a!==n.userId?await this.signalingHandlers.handleOffer(a,e.offer):"ANSWER"===t&&e.answer&&a&&a!==n.userId?await this.signalingHandlers.handleAnswer(a,e.answer):"ICE_CANDIDATE"===t&&e.candidate&&a&&a!==n.userId?await this.signalingHandlers.handleIceCandidate(a,e.candidate):"LEAVE"===t&&a&&this.signalingHandlers.handleLeave(a))}attemptReconnection(e){return this.reconnectionManager.attempt(e)}_sendSignal(e){this.stateManager.safeSendMessage({type:"SIGNAL_SEND",message:e},function(){})}clearAll(){this.peerConnections.forEach(e=>{try{e.close()}catch(e){}}),this.peerConnections.clear(),this.peersThatLeft.clear(),this.remoteVideos.forEach(e=>{try{e.srcObject&&(e.srcObject=null)}catch(e){}e.remove()}),this.remoteVideos.clear(),this.remoteStreams.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}}(n,r),l=new class{constructor(e){this.stateManager=e,this.urlMonitorInterval=null,this.lastUrl=null}start(){this.lastUrl=window.location.href}stop(){this.urlMonitorInterval&&(clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=null)}saveState(){const e=this.stateManager.getState();if(!e.partyActive)return;const t=this.getRestorationState()||{},a={roomId:e.roomId,currentTime:t.currentTime||null,isPlaying:"boolean"==typeof t.isPlaying?t.isPlaying:null,timestamp:Date.now()};sessionStorage.setItem("toperparty_restore",JSON.stringify(a))}clearState(){sessionStorage.removeItem("toperparty_restore")}getRestorationState(){const e=sessionStorage.getItem("toperparty_restore");if(!e)return null;try{const t=JSON.parse(e);if(Date.now()-t.timestamp<3e4)return t}catch(e){console.error("[toperparty] Failed to parse restoration state:",e)}return null}}(n);let d=null;!function(){const e=l.getRestorationState();e&&(l.clearState(),n.setRestoringFlag(!0),setTimeout(function(){chrome.runtime.sendMessage({type:"RESTORE_PARTY",roomId:e.roomId}),setTimeout(function(){n.setRestoringFlag(!1)},2e3)},1e3))}(),chrome.runtime.onMessage.addListener((e,t,a)=>{if("REQUEST_MEDIA_STREAM"===e.type)return navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{d=e,c.setLocalStream(e),c.onLocalStreamAvailable(e),a({success:!0})}).catch(e=>a({success:!1,error:e.message})),!0;"PARTY_STARTED"===e.type&&(n.startParty(e.userId,e.roomId),o.setup(),l.start(),a({success:!0})),"PARTY_STOPPED"===e.type&&(n.stopParty(),o.teardown(),l.stop(),l.clearState(),c.clearAll(),d&&(d.getTracks().forEach(e=>e.stop()),d=null),a({success:!0})),"SIGNAL"===e.type&&c.handleSignal(e.message),"APPLY_PLAYBACK_CONTROL"===e.type&&o.handlePlaybackControl(e.control,e.fromUserId),"APPLY_SYNC_PLAYBACK"===e.type&&o.handlePassiveSync(e.currentTime,e.isPlaying,e.fromUserId,e.timestamp),"APPLY_SEEK"===e.type&&o.handleSeek(e.currentTime,e.isPlaying,e.fromUserId),"APPLY_URL_CHANGE"===e.type&&(n.restoringPartyState||(window.location.href=e.url)),"HANDLE_REQUEST_SYNC"===e.type&&o.handleRequestSync(e.fromUserId),"APPLY_SYNC_RESPONSE"===e.type&&o.handleSyncResponse(e.currentTime,e.isPlaying,e.fromUserId)}),window.addEventListener("beforeunload",()=>{n.isActive()&&l.saveState()})})();
//# sourceMappingURL=content-script.js.map