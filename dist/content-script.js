(()=>{"use strict";class e{constructor(){this.suppressLocalUntil=0}set(e){this.suppressLocalUntil=Date.now()+e}isActive(){return Date.now()<this.suppressLocalUntil}}function t({video:e,state:t,isInitializedRef:n,lock:o,onPlay:a,onPause:i,onSeek:r}){const s=()=>{console.log("[EventListeners] Play event fired - checking conditions:",{isActive:t.isActive(),isInitialized:n.get(),lockActive:o.isActive()}),t.isActive()?n.get()?o.isActive()?console.log("[EventListeners] Ignoring play - lock active"):(console.log("[EventListeners] Play event detected - broadcasting"),a(e)):console.log("[EventListeners] Ignoring play - not initialized"):console.log("[EventListeners] Ignoring play - party not active")},l=()=>{console.log("[EventListeners] Pause event fired - checking conditions:",{isActive:t.isActive(),isInitialized:n.get(),lockActive:o.isActive()}),t.isActive()?n.get()?o.isActive()?console.log("[EventListeners] Ignoring pause - lock active"):(console.log("[EventListeners] Pause event detected - broadcasting"),i(e)):console.log("[EventListeners] Ignoring pause - not initialized"):console.log("[EventListeners] Ignoring pause - party not active")},c=()=>{console.log("[EventListeners] Seek event fired - checking conditions:",{isActive:t.isActive(),isInitialized:n.get(),lockActive:o.isActive()}),t.isActive()?n.get()?o.isActive()?console.log("[EventListeners] Ignoring seek - lock active"):(console.log("[EventListeners] Seek event detected - broadcasting"),r(e)):console.log("[EventListeners] Ignoring seek - not initialized"):console.log("[EventListeners] Ignoring seek - party not active")};return e.addEventListener("play",s),e.addEventListener("pause",l),e.addEventListener("seeked",c),console.log("[EventListeners] Event listeners attached to video element"),{video:e,handlePlay:s,handlePause:l,handleSeeked:c}}class n{constructor(e){this.value=e}get(){return this.value}set(e){this.value=e}}function o(e,t,n){const o=e.getSenders().find(e=>e.track&&e.track.kind===t.kind);if(o)o.replaceTrack(t).catch(e=>console.warn("[WebRTCManager] Error replacing track",e));else try{e.addTrack(t,n)}catch(e){}}console.log("[Content Script] Initializing managers...");const a=new class{constructor(){this.partyActive=!1,this.userId=null,this.roomId=null,this.restoringPartyState=!1}startParty(e,t){this.partyActive=!0,this.userId=e,this.roomId=t}stopParty(){this.partyActive=!1,this.userId=null,this.roomId=null}isActive(){return this.partyActive}getUserId(){return this.userId}getRoomId(){return this.roomId}getState(){return{partyActive:this.partyActive,userId:this.userId,roomId:this.roomId,restoringPartyState:this.restoringPartyState}}isInParty(){return!!(this.partyActive&&this.userId&&this.roomId)}setRestoringFlag(e){this.restoringPartyState=e}isExtensionContextValid(){try{return chrome.runtime&&chrome.runtime.id}catch{return!1}}safeSendMessage(e,t){if(this.isExtensionContextValid()){console.log("[StateManager] Sending message:",e.type,e);try{chrome.runtime.sendMessage(e,n=>{chrome.runtime.lastError?console.error("[StateManager] Error sending message:",e.type,chrome.runtime.lastError.message):console.log("[StateManager] Message sent successfully:",e.type,n),t&&t(n)})}catch(t){console.error("[StateManager] Exception sending message:",e.type,t.message,t)}}else if(console.warn("[StateManager] Extension context invalid - page needs reload after extension update"),!document.getElementById("toperparty-reload-notice")){const e=document.createElement("div");e.id="toperparty-reload-notice",e.style.cssText="position:fixed;top:20px;right:20px;background:#e50914;color:white;padding:15px;border-radius:8px;z-index:99999;font-family:Arial;box-shadow:0 4px 6px rgba(0,0,0,0.3);",e.innerHTML="<strong>ToperParty:</strong> Extension updated. Please reload this page.",document.body.appendChild(e)}}},i=new class{constructor(){this.localPreviewVideo=null,this.remoteVideos=new Map,this.remoteStreams=new Map,this.streamMonitorInterval=null}makeDraggable(e){let t,n,o,a,i=!1;e.addEventListener("mousedown",function(t){const n=window.getComputedStyle(e),r=(n.bottom,n.left,n.right,e.getBoundingClientRect());e.style.left=r.left+"px",e.style.top=r.top+"px",e.style.bottom="auto",e.style.right="auto",o=t.clientX-r.left,a=t.clientY-r.top,i=!0,e.style.opacity="0.8"}),e.addEventListener("mouseup",function(r){o=t,a=n,i=!1,e.style.opacity="1"}),e.addEventListener("mousemove",function(r){if(i){r.preventDefault(),t=r.clientX-o,n=r.clientY-a;const i=window.innerWidth-e.offsetWidth,g=window.innerHeight-e.offsetHeight;t=Math.max(0,Math.min(t,i)),n=Math.max(0,Math.min(n,g)),s=t,l=n,(c=e).style.left=s+"px",c.style.top=l+"px"}var s,l,c}),e.style.cursor="move"}getRemoteVideos(){return this.remoteVideos}getRemoteStreams(){return this.remoteStreams}setLocalPreviewVideo(e){this.localPreviewVideo=e}getLocalPreviewVideo(){return this.localPreviewVideo}setStreamMonitorInterval(e){this.streamMonitorInterval=e}getStreamMonitorInterval(){return this.streamMonitorInterval}clearStreamMonitorInterval(){this.streamMonitorInterval&&(clearInterval(this.streamMonitorInterval),this.streamMonitorInterval=null)}attachLocalPreview(e){console.log("[UIManager] Attaching local preview with stream:",e),this.removeLocalPreview();const t=document.createElement("video");t.id="toperparty-local-preview",t.autoplay=!0,t.muted=!0,t.playsInline=!0,t.style.position="fixed",t.style.bottom="20px",t.style.left="20px",t.style.width="240px",t.style.height="160px",t.style.zIndex="10001",t.style.border="2px solid #e50914",t.style.borderRadius="4px",t.style.transform="scaleX(-1)";try{t.srcObject=e,console.log("[UIManager] Set srcObject on local preview")}catch(n){console.warn("[UIManager] srcObject failed, trying createObjectURL:",n),t.src=URL.createObjectURL(e)}document.body.appendChild(t),this.localPreviewVideo=t,console.log("[UIManager] Local preview video appended to body"),this.makeDraggable(t),t.play().catch(e=>{console.warn("[UIManager] Local preview play() failed:",e)})}removeLocalPreview(){if(this.localPreviewVideo){console.log("[UIManager] Removing local preview video");try{this.localPreviewVideo.srcObject&&(this.localPreviewVideo.srcObject=null)}catch(e){console.warn("[UIManager] Error clearing srcObject:",e)}this.localPreviewVideo.remove(),this.localPreviewVideo=null}}clearAll(){this.removeLocalPreview(),this.remoteVideos.clear(),this.remoteStreams.clear(),this.clearStreamMonitorInterval()}},r=new class{constructor(){this.injectAPIBridge()}injectAPIBridge(){const e=document.createElement("script");e.src=chrome.runtime.getURL("netflix-api-bridge.js"),(document.head||document.documentElement).appendChild(e),e.onload=function(){e.remove()}}_sendCommand(e,t=[]){return new Promise(function(n){const o=function(t){t.detail.command===e&&(document.removeEventListener("__toperparty_response",o),n(t.detail.result))};document.addEventListener("__toperparty_response",o),setTimeout(function(){n(null)},1e3),document.dispatchEvent(new CustomEvent("__toperparty_command",{detail:{command:e,args:t}}))})}play(){return this._sendCommand("play")}pause(){return this._sendCommand("pause")}seek(e){return this._sendCommand("seek",[e])}getCurrentTime(){return this._sendCommand("getCurrentTime")}isPaused(){return this._sendCommand("isPaused")}setVolume(e){return this._sendCommand("setVolume",[e])}getVolume(){return this._sendCommand("getVolume")}getVideoElement(){const e=document.querySelectorAll("video");for(const t of e)if(!t.id||!t.id.startsWith("toperparty-"))return t;return null}},s=new class{constructor(t,o){this.state=t,this.netflix=o,this.lock=new e,this.isInitializedRef=new n(!1),this.listeners=null,this.remote=function({state:e,netflix:t,lock:n,isInitializedRef:o}){async function a(e,t,o){n.set(t);try{await o()}catch(t){console.error(`[SyncManager] Error applying remote ${e}:`,t)}}return{async handleRequestSync(n){if(!o.get())return void console.log("[SyncManager] Not yet initialized, ignoring sync request");const a=window.location.href;if(window.location.pathname.startsWith("/watch"))try{const o=await t.getCurrentTime(),i=await t.isPaused();if(null==o)return void console.log("[SyncManager] Invalid playback state, ignoring sync request");const r=o/1e3;console.log("[SyncManager] Sending SYNC_RESPONSE to",n,"at",r.toFixed(2)+"s",i?"paused":"playing","URL:",a),e.safeSendMessage({type:"SYNC_RESPONSE",targetUserId:n,currentTime:r,isPlaying:!i,url:a})}catch(e){console.error("[SyncManager] Error handling sync request:",e)}else console.log("[SyncManager] On browse page, not sending sync response")},async handleSyncResponse(e,n,i,r){if(o.get())return void console.log("[SyncManager] Already initialized, ignoring late SYNC_RESPONSE");if(null==e||"number"!=typeof e||e<0)return void console.warn("[SyncManager] Invalid SYNC_RESPONSE - bad currentTime:",e);console.log("[SyncManager] Initial sync from",i,"seeking to",e.toFixed(2)+"s",n?"playing":"paused","URL:",r);const s=window.location.href,l=window.location.pathname,c=l.startsWith("/watch"),g=l.startsWith("/browse"),d=r&&new URL(r).pathname.startsWith("/watch");return!c&&d&&g?(console.log("[SyncManager] On browse page during initial join, other user on /watch - navigating to their show"),sessionStorage.setItem("toperparty_pending_sync",JSON.stringify({currentTime:e,isPlaying:n,timestamp:Date.now()})),void(window.location.href=r)):c?r&&r!==s?(console.log("[SyncManager] URL mismatch - navigating from",s,"to",r),sessionStorage.setItem("toperparty_pending_sync",JSON.stringify({currentTime:e,isPlaying:n,timestamp:Date.now()})),void(window.location.href=r)):(o.set(!0),void await a("initial-sync",1500,async()=>{await t.seek(1e3*e);const o=await t.isPaused();n&&o?(console.log("[SyncManager] Remote is playing, starting playback"),await t.play()):n||o||(console.log("[SyncManager] Remote is paused, pausing playback"),await t.pause())})):(console.log("[SyncManager] Not on /watch page - ignoring sync response"),void o.set(!0))},async handlePlaybackControl(e,n,o){console.log("[SyncManager] Remote",e.toUpperCase(),"at",n,"from",o),await a(e,1e3,async()=>{if(null!=n){const o=1e3*n;await t.seek(o),console.log("[SyncManager] Seeked to",n.toFixed(2)+"s before",e)}"play"===e?await t.play():await t.pause()})},async handleSeek(e,n,o){console.log("[SyncManager] Remote SEEK to",e.toFixed(2)+"s",n?"playing":"paused","from",o),await a("seek",1200,async()=>{await t.seek(1e3*e);const o=await t.isPaused();n&&o?await t.play():n||o||await t.pause()})}}}({state:this.state,netflix:this.netflix,lock:this.lock,isInitializedRef:this.isInitializedRef})}async setup(){try{console.log("[SyncManager] Starting setup - waiting for video element...");const e=await this.waitForVideo();if(!e)return void console.warn("[SyncManager] Netflix video element not found");console.log("[SyncManager] Video element found, setting up event listeners");const n=sessionStorage.getItem("toperparty_pending_sync");if(n)try{const o=JSON.parse(n);if(Date.now()-o.timestamp<1e4){console.log("[SyncManager] Applying pending sync from URL navigation"),sessionStorage.removeItem("toperparty_pending_sync"),this.isInitializedRef.set(!0),this.lock.set(1500),await this.netflix.seek(1e3*o.currentTime);const n=await this.netflix.isPaused();o.isPlaying&&n?await this.netflix.play():o.isPlaying||n||await this.netflix.pause();const a=t({video:e,state:this.state,isInitializedRef:this.isInitializedRef,lock:this.lock,onPlay:e=>this.broadcastPlay(e),onPause:e=>this.broadcastPause(e),onSeek:e=>this.broadcastSeek(e)});return this.listeners=a,void console.log("[SyncManager] Setup complete with pending sync applied")}console.log("[SyncManager] Pending sync expired, ignoring"),sessionStorage.removeItem("toperparty_pending_sync")}catch(e){console.error("[SyncManager] Error applying pending sync:",e),sessionStorage.removeItem("toperparty_pending_sync")}this.isInitializedRef.set(!1),console.log("[SyncManager] Requesting initial sync from other clients"),this.state.safeSendMessage({type:"REQUEST_SYNC"}),setTimeout(()=>{this.isInitializedRef.get()?console.log("[SyncManager] Already initialized, skipping timeout initialization"):(console.log("[SyncManager] No sync response received after 2s, marking as initialized"),this.isInitializedRef.set(!0),console.log("[SyncManager] isInitialized is now:",this.isInitializedRef.get()))},2e3);const o=t({video:e,state:this.state,isInitializedRef:this.isInitializedRef,lock:this.lock,onPlay:e=>this.broadcastPlay(e),onPause:e=>this.broadcastPause(e),onSeek:e=>this.broadcastSeek(e)});this.listeners=o,console.log("[SyncManager] Setup complete - ready to sync")}catch(e){console.error("[SyncManager] Error setting up playback sync:",e)}}teardown(){if(console.log("[SyncManager] Tearing down sync manager"),this.listeners&&this.listeners.video){const{video:e,handlePlay:t,handlePause:n,handleSeeked:o}=this.listeners;try{e.removeEventListener("play",t),e.removeEventListener("pause",n),e.removeEventListener("seeked",o),console.log("[SyncManager] Event listeners removed")}catch(e){console.warn("[SyncManager] Error removing listeners:",e)}this.listeners=null}this.isInitializedRef.set(!1)}waitForVideo(){return new Promise((e,t)=>{const n=setTimeout(()=>t(new Error("Video element timeout")),1e4),o=()=>{const t=this.netflix.getVideoElement();t?(clearTimeout(n),e(t)):setTimeout(o,100)};o()})}isOnWatchPage(){return window.location.pathname.startsWith("/watch")}broadcastPlay(e){this.isOnWatchPage()?(console.log("[SyncManager] Broadcasting PLAY event"),this.state.safeSendMessage({type:"PLAY_PAUSE",control:"play",currentTime:e.currentTime})):console.log("[SyncManager] Ignoring PLAY event - not on /watch page")}broadcastPause(e){this.isOnWatchPage()?(console.log("[SyncManager] Broadcasting PAUSE event"),this.state.safeSendMessage({type:"PLAY_PAUSE",control:"pause",currentTime:e.currentTime})):console.log("[SyncManager] Ignoring PAUSE event - not on /watch page")}broadcastSeek(e){this.isOnWatchPage()?(console.log("[SyncManager] Broadcasting SEEK event at",e.currentTime),this.state.safeSendMessage({type:"SEEK",currentTime:e.currentTime,isPlaying:!e.paused})):console.log("[SyncManager] Ignoring SEEK event - not on /watch page")}handleRequestSync(e){return this.remote.handleRequestSync(e)}handleSyncResponse(e,t,n,o){return this.remote.handleSyncResponse(e,t,n,o)}handlePlaybackControl(e,t,n){return this.remote.handlePlaybackControl(e,t,n)}handleSeek(e,t,n){return this.remote.handleSeek(e,t,n)}}(a,r),l=new class{constructor(e,t){this.stateManager=e,this.uiManager=t,this.peerConnections=new Map,this.remoteStreams=this.uiManager.getRemoteStreams(),this.remoteVideos=this.uiManager.getRemoteVideos(),this.peersThatLeft=new Set,this.localStream=null;const n=function(e){function t(){const e=document.createElement("div");return e.className="toperparty-spinner",e.style.cssText="\n      width: 40px;\n      height: 40px;\n      border: 4px solid rgba(255, 255, 255, 0.3);\n      border-top: 4px solid #00aaff;\n      border-radius: 50%;\n      animation: toperparty-spin 1s linear infinite;\n      margin-bottom: 12px;\n    ",e}function n(e){let t,n,o,a,i=!1;e.addEventListener("mousedown",function(t){window.getComputedStyle(e);const n=e.getBoundingClientRect();e.style.left=n.left+"px",e.style.top=n.top+"px",e.style.bottom="auto",e.style.right="auto",o=t.clientX-n.left,a=t.clientY-n.top,i=!0,e.style.opacity="0.8"}),e.addEventListener("mouseup",function(r){o=t,a=n,i=!1,e.style.opacity="1"}),e.addEventListener("mousemove",function(r){if(i){r.preventDefault(),t=r.clientX-o,n=r.clientY-a;const i=window.innerWidth-e.offsetWidth,s=window.innerHeight-e.offsetHeight;t=Math.max(0,Math.min(t,i)),n=Math.max(0,Math.min(n,s)),e.style.left=t+"px",e.style.top=n+"px"}}),e.style.cursor="move"}function o(t){console.log("[RemoteVideoManager] Removing remote video for peer:",t);const n=e.get(t);if(n){try{n.srcObject&&(n.srcObject.getTracks().forEach(e=>e.stop()),n.srcObject=null)}catch(e){console.warn("[RemoteVideoManager] Error cleaning up stream:",e)}const o=n.parentElement;o&&o.id==="toperparty-container-"+t?o.remove():n.remove(),e.delete(t)}const o=document.getElementById("toperparty-container-"+t);o&&(console.log("[RemoteVideoManager] Found orphaned container, removing"),o.remove());const a=document.getElementById("toperparty-remote-"+t);if(a&&a!==n){console.log("[RemoteVideoManager] Found orphaned video element, removing");try{a.srcObject&&(a.srcObject=null)}catch(e){}a.remove()}const i=document.getElementById("toperparty-overlay-"+t);i&&i.remove()}return{add:function(a,i){console.log("[RemoteVideoManager] Adding remote video for peer:",a,"stream:",i,"tracks:",i.getTracks()),console.log("[RemoteVideoManager] Current remoteVideos map size:",e.size,"peers:",Array.from(e.keys()));const r=document.getElementById("toperparty-remote-"+a);if(r){if(console.log("[RemoteVideoManager] Video already exists in DOM for peer:",a,"skipping duplicate creation"),r.srcObject!==i){console.log("[RemoteVideoManager] Updating stream on existing video element"),r.srcObject=i;const e=document.getElementById("toperparty-overlay-"+a);e&&e.remove()}return void(e.has(a)||e.set(a,r))}let s=document.getElementById("toperparty-container-"+a);s?console.log("[RemoteVideoManager] Using existing placeholder container for peer:",a):(o(a),s=document.createElement("div"),s.id="toperparty-container-"+a,s.style.position="fixed",s.style.bottom="20px",s.style.right=20+180*e.size+"px",s.style.width="240px",s.style.height="160px",s.style.zIndex=10001,s.style.border="2px solid #00aaff",s.style.borderRadius="4px",s.style.backgroundColor="#000");const l=document.createElement("video");l.id="toperparty-remote-"+a,l.autoplay=!0,l.playsInline=!0,l.muted=!0,l.style.width="100%",l.style.height="100%",l.style.border="2px solid #00aaff",l.style.borderRadius="4px",l.style.backgroundColor="#000";let c=document.getElementById("toperparty-overlay-"+a);if(!c){c=document.createElement("div"),c.id="toperparty-overlay-"+a,c.style.position="absolute",c.style.top="0",c.style.left="0",c.style.width="100%",c.style.height="100%",c.style.backgroundColor="rgba(0, 0, 0, 0.85)",c.style.display="flex",c.style.flexDirection="column",c.style.alignItems="center",c.style.justifyContent="center",c.style.color="#fff",c.style.fontSize="14px",c.style.fontFamily="Arial, sans-serif",c.style.borderRadius="4px",c.style.pointerEvents="none";const e=t(),n=document.createElement("div");n.textContent="Connecting...",n.style.fontWeight="500",c.appendChild(e),c.appendChild(n)}if(!document.getElementById("toperparty-spinner-styles")){const e=document.createElement("style");e.id="toperparty-spinner-styles",e.textContent="\n        @keyframes toperparty-spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n        @keyframes toperparty-pulse {\n          0%, 100% { opacity: 0.3; }\n          50% { opacity: 1; }\n        }\n      ",document.head.appendChild(e)}s.appendChild(l),c.parentElement||s.appendChild(c),s.parentElement||(document.body.appendChild(s),n(s)),console.log("[RemoteVideoManager] Added video to container:",s.id);const g=i.getTracks().filter(e=>"live"===e.readyState);console.log("[RemoteVideoManager] Stream has",g.length,"active tracks:",g.map(e=>`${e.kind}:${e.id.substring(0,8)}`).join(", "));try{l.srcObject=i,console.log("[RemoteVideoManager] Set srcObject successfully")}catch(e){console.warn("[RemoteVideoManager] srcObject failed:",e)}e.set(a,l);const d=()=>{l.play().then(()=>{console.log("[RemoteVideoManager] Video playing, unmuting and removing overlay"),l.muted=!1,l.volume=1,c.remove()}).catch(e=>{console.warn("[RemoteVideoManager] Play failed:",e.name,e.message),l.muted=!1,c.remove()})};if(g.length>0)d();else{console.log("[RemoteVideoManager] Waiting for stream tracks to become active"),c.innerHTML='<div style="text-align: center;"><div style="margin-bottom: 8px;">●</div><div>Waiting for stream...</div></div>';const e=setInterval(()=>{i.getTracks().filter(e=>"live"===e.readyState).length>0&&(clearInterval(e),console.log("[RemoteVideoManager] Tracks now active, playing video"),d())},100);setTimeout(()=>{clearInterval(e),c.parentNode&&(console.log("[RemoteVideoManager] Timeout waiting for tracks, removing overlay"),c.remove())},5e3)}},remove:o,showReconnecting:function(e){console.log("[RemoteVideoManager] Showing reconnecting overlay for peer:",e);let n=document.getElementById("toperparty-overlay-"+e);if(n){n.innerHTML="";const e=t(),o=document.createElement("div");return o.textContent="Reconnecting...",o.style.fontWeight="500",n.appendChild(e),n.appendChild(o),void(n.style.display="flex")}const o=document.getElementById("toperparty-container-"+e);if(!o)return void console.warn("[RemoteVideoManager] Cannot show reconnecting - container not found");n=document.createElement("div"),n.id="toperparty-overlay-"+e,n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0, 0, 0, 0.85)",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.color="#fff",n.style.fontSize="14px",n.style.fontFamily="Arial, sans-serif",n.style.borderRadius="4px",n.style.pointerEvents="none";const a=t(),i=document.createElement("div");i.textContent="Reconnecting...",i.style.fontWeight="500",n.appendChild(a),n.appendChild(i),o.appendChild(n)},hideOverlay:function(e){const t=document.getElementById("toperparty-overlay-"+e);t&&(console.log("[RemoteVideoManager] Hiding overlay for peer:",e),t.remove())},showPlaceholder:function(o){console.log("[RemoteVideoManager] Showing placeholder for peer:",o);let a=document.getElementById("toperparty-container-"+o);if(a)return void console.log("[RemoteVideoManager] Placeholder already exists for peer:",o,"- reusing it");console.log("[RemoteVideoManager] Creating NEW placeholder container for peer:",o),a=document.createElement("div"),a.id="toperparty-container-"+o,a.style.position="fixed",a.style.bottom="20px",a.style.right=20+180*e.size+"px",a.style.width="240px",a.style.height="160px",a.style.zIndex=10001,a.style.border="2px solid #00aaff",a.style.borderRadius="4px",a.style.backgroundColor="#000";const i=document.createElement("div");i.id="toperparty-overlay-"+o,i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.backgroundColor="rgba(0, 0, 0, 0.85)",i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="center",i.style.justifyContent="center",i.style.color="#fff",i.style.fontSize="14px",i.style.fontFamily="Arial, sans-serif",i.style.borderRadius="4px",i.style.pointerEvents="none";const r=t(),s=document.createElement("div");s.textContent="Connecting...",s.style.fontWeight="500",i.appendChild(r),i.appendChild(s),a.appendChild(i),document.body.appendChild(a),n(a),console.log("[RemoteVideoManager] Created placeholder container:",a.id)}}}(this.remoteVideos),a={},i=function({stateManager:e,sendSignal:t,remoteStreams:n,remoteVideos:o,addRemoteVideo:a,attemptReconnection:i,clearReconnection:r,removeRemoteVideo:s,peersThatLeft:l,showReconnecting:c,hideOverlay:g,showPlaceholder:d}){return function(p){console.log("[PeerConnection] Creating peer connection for peerId:",p),s(p),n.delete(p),d(p);const m=e.getState(),h=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]}]});return h.onicecandidate=e=>{e.candidate&&(console.log("[PeerConnection] ICE candidate for peer:",p,e.candidate),t({type:"ICE_CANDIDATE",from:m.userId,to:p,candidate:e.candidate}))},h.ontrack=e=>{console.log("[PeerConnection] ontrack fired for peer:",p,"track:",e.track,"streams:",e.streams);let t=e.streams&&e.streams[0]||n.get(p);if(t||(console.log("[PeerConnection] Creating new MediaStream for peer:",p),t=new MediaStream,n.set(p,t)),e.track){console.log("[PeerConnection] Adding track to stream:",e.track.kind,e.track.id);try{t.getTracks().find(t=>t.id===e.track.id)?console.log("[PeerConnection] Track already in stream, skipping"):t.addTrack(e.track)}catch(e){console.warn("[PeerConnection] Error adding track:",e)}}const i=o.has(p),r=!!document.getElementById("toperparty-remote-"+p);if(i||r){console.log("[PeerConnection] Video already exists for peer:",p,"inMap:",i,"inDom:",r);const e=o.get(p)||document.getElementById("toperparty-remote-"+p);e&&e.srcObject!==t&&(console.log("[PeerConnection] Updating existing video element with new stream"),e.srcObject=t,i||o.set(p,e))}else{const e=t.getTracks(),n=e.some(e=>"audio"===e.kind),o=e.some(e=>"video"===e.kind);console.log("[PeerConnection] Stream status - audio:",n,"video:",o,"total tracks:",e.length),n&&o?(console.log("[PeerConnection] Both tracks present, adding remote video for peer:",p),a(p,t)):console.log("[PeerConnection] Waiting for more tracks before creating video element")}},h.onconnectionstatechange=()=>{console.log("[PeerConnection] Connection state changed for peer:",p,"→",h.connectionState),"connected"===h.connectionState?(r(p),g(p)):"disconnected"===h.connectionState?l.has(p)?(s(p),r(p)):(console.log("[PeerConnection] Connection disconnected, attempting reconnection while keeping video visible"),c(p),i(p)):"failed"===h.connectionState?(console.log("[PeerConnection] Connection failed for peer:",p),l.has(p)?(s(p),r(p)):(s(p),i(p))):"closed"===h.connectionState&&(s(p),r(p))},h}}({stateManager:this.stateManager,sendSignal:e=>this._sendSignal(e),remoteStreams:this.remoteStreams,remoteVideos:this.remoteVideos,addRemoteVideo:n.add,attemptReconnection:e=>a.attempt(e),clearReconnection:e=>a.clear(e),removeRemoteVideo:e=>{n.remove(e),this.remoteStreams.delete(e)},peersThatLeft:this.peersThatLeft,showReconnecting:n.showReconnecting,hideOverlay:n.hideOverlay,showPlaceholder:n.showPlaceholder});Object.assign(a,function({stateManager:e,peerConnections:t,peersThatLeft:n,localStream:o,createPeer:a,sendSignal:i,addOrReplaceTrack:r}){const s=new Map,l=new Map;function c(e){s.delete(e);const t=l.get(e);t&&(clearTimeout(t),l.delete(e))}return{attempt:async function g(d){if(!e.isInParty())return;if(n.has(d))return void c(d);const p=s.get(d)||0,m=Math.min(500*Math.pow(2,p),1e4);if(p>=5)return console.log("[Reconnection] Max attempts reached for peer:",d),void c(d);console.log("[Reconnection] Attempting reconnection for peer:",d,"attempt:",p+1,"delay:",m+"ms"),s.set(d,p+1);const h=l.get(d);h&&clearTimeout(h);const y=setTimeout(async()=>{const n=t.get(d);if(n){try{n.close()}catch(e){}t.delete(d)}try{const n=a(d);t.set(d,n);const s="function"==typeof o?o():o;s&&s.getTracks().forEach(e=>r(n,e,s));const l=await n.createOffer();await n.setLocalDescription(l);const c=e.getState();i({type:"OFFER",from:c.userId,to:d,offer:n.localDescription})}catch(e){console.error("[WebRTCManager] Reconnection failed:",e),g(d)}},m);l.set(d,y)},clear:c}}({stateManager:this.stateManager,peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,localStream:()=>this.localStream,createPeer:i,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:o})),this.reconnectionManager=a,this.createPeer=i,this.videoManager=n,this.signalingHandlers=function({getState:e,peerConnections:t,peersThatLeft:n,getLocalStream:o,createPeer:a,sendSignal:i,addOrReplaceTrack:r,clearReconnection:s,removeRemoteVideo:l}){return{async handleJoin(c){console.log("[Signaling] Handling JOIN from",c);const g=e();if(c===g.userId)return void console.log("[Signaling] Ignoring JOIN from self");s(c),n.delete(c);let d=t.get(c);if(d){const e=d.connectionState;if(console.log("[Signaling] Already have peer connection for",c,"state:",e),"connected"===e||"connecting"===e){console.log("[Signaling] Reusing existing connection - ensuring tracks are present");const e=o();if(e){let t=!1;if(e.getTracks().forEach(n=>{const o=d.getSenders().find(e=>e.track&&e.track.kind===n.kind);o&&o.track.id===n.id||(console.log("[Signaling] Track changed, replacing:",n.kind,n.id),r(d,n,e),t=!0)}),t&&"stable"===d.signalingState){console.log("[Signaling] Renegotiating due to track changes");const e=await d.createOffer();await d.setLocalDescription(e),i({type:"OFFER",from:g.userId,to:c,offer:d.localDescription})}}return}console.log("[Signaling] Cleaning up existing connection in state:",e),s(c),l(c);try{d.close()}catch(e){}t.delete(c),d=null}if(!d)try{console.log("[Signaling] Creating new peer connection for",c),d=a(c),t.set(c,d);const e=o();console.log("[Signaling] Local stream:",e,"tracks:",e?e.getTracks().length:0),e?e.getTracks().forEach(t=>{console.log("[Signaling] Adding local track to peer:",t.kind,t.id),r(d,t,e)}):console.warn("[Signaling] No local stream available when handling JOIN"),console.log("[Signaling] Creating and sending OFFER to",c);const n=await d.createOffer();await d.setLocalDescription(n),i({type:"OFFER",from:g.userId,to:c,offer:d.localDescription})}catch(e){console.error("[Signaling] Error handling JOIN:",e),t.delete(c)}},async handleOffer(l,c){console.log("[Signaling] Handling OFFER from",l);const g=e();if(l===g.userId)return void console.log("[Signaling] Ignoring OFFER from self");let d=t.get(l);if(d)if(console.log("[Signaling] Existing peer connection state:",d.signalingState),"closed"!==d.signalingState&&"stable"!==d.signalingState){console.log("[Signaling] Closing existing peer connection in state:",d.signalingState);try{d.close()}catch(e){}t.delete(l),d=null}else if("stable"===d.signalingState){console.log("[Signaling] Closing stable peer connection for renegotiation");try{d.close()}catch(e){}t.delete(l),d=null}d||(console.log("[Signaling] Creating new peer connection for",l),s(l),n.delete(l),d=a(l),t.set(l,d));try{console.log("[Signaling] Setting remote description, current state:",d.signalingState),await d.setRemoteDescription(new RTCSessionDescription(c));const e=o();console.log("[Signaling] Local stream:",e,"tracks:",e?e.getTracks().length:0),e?e.getTracks().forEach(t=>{console.log("[Signaling] Adding local track to peer:",t.kind,t.id),r(d,t,e)}):console.warn("[Signaling] No local stream available when handling OFFER"),console.log("[Signaling] Creating and sending ANSWER to",l);const t=await d.createAnswer();await d.setLocalDescription(t),i({type:"ANSWER",from:g.userId,to:l,answer:d.localDescription})}catch(e){console.error("[Signaling] Error handling offer:",e.name,e.message),console.error("[Signaling] Full error:",e),t.delete(l);try{d.close()}catch(e){}}},async handleAnswer(e,n){console.log("[Signaling] Handling ANSWER from",e);const o=t.get(e);if(o)if(console.log("[Signaling] Peer connection state:",{signalingState:o.signalingState,connectionState:o.connectionState,iceConnectionState:o.iceConnectionState}),"have-local-offer"===o.signalingState){console.log("[Signaling] Setting remote description from ANSWER");try{await o.setRemoteDescription(new RTCSessionDescription(n)),console.log("[Signaling] Remote description set successfully")}catch(n){if(console.error("[Signaling] Error handling answer:",n.name,n.message),console.error("[Signaling] Full error:",n),"InvalidStateError"===n.name||"OperationError"===n.name){console.log("[Signaling] Closing peer connection due to state error");try{o.close()}catch(e){}t.delete(e)}}}else"stable"===o.signalingState?console.log("[Signaling] Received ANSWER but already in stable state (connection:",o.connectionState+") - likely duplicate, ignoring"):"have-remote-offer"===o.signalingState?console.warn("[Signaling] Received ANSWER but expecting to send one (have-remote-offer) - might be glare, ignoring"):"closed"===o.signalingState?console.warn("[Signaling] Received ANSWER but peer connection is closed - ignoring"):console.warn("[Signaling] Cannot handle ANSWER - unexpected state:",o.signalingState);else console.warn("[Signaling] Cannot handle ANSWER - no peer connection found for",e)},async handleIceCandidate(e,n){console.log("[Signaling] Handling ICE_CANDIDATE from",e);const o=t.get(e);if(o)try{await o.addIceCandidate(new RTCIceCandidate(n)),console.log("[Signaling] ICE candidate added successfully")}catch(e){console.warn("[Signaling] Error adding ICE candidate",e)}else console.warn("[Signaling] No peer connection found for ICE candidate from",e)},handleLeave(e){console.log("[Signaling] Handling LEAVE from",e),n.add(e);const o=t.get(e);if(o){try{o.close()}catch(e){}t.delete(e)}s(e),l(e)}}}({getState:()=>this.stateManager.getState(),peerConnections:this.peerConnections,peersThatLeft:this.peersThatLeft,getLocalStream:()=>this.localStream,createPeer:i,sendSignal:e=>this._sendSignal(e),addOrReplaceTrack:o,clearReconnection:a.clear,removeRemoteVideo:e=>{n.remove(e),this.remoteStreams.delete(e)}})}setLocalStream(e){this.localStream=e}getLocalStream(){return this.localStream}onLocalStreamAvailable(e){this.localStream=e,this.peerConnections.forEach(t=>{try{e.getTracks().forEach(n=>o(t,n,e))}catch(e){}})}async handleSignal(e){if(console.log("[WebRTCManager] handleSignal called with:",e),!e||!e.type)return void console.warn("[WebRTCManager] Invalid message:",e);const t=e.type,n=e.userId||e.from,o=e.to,a=this.stateManager.getState();console.log("[WebRTCManager] Processing signal type:",t,"from:",n,"to:",o,"myId:",a.userId),"OFFER"!==t&&"ANSWER"!==t&&"ICE_CANDIDATE"!==t&&"SYNC_RESPONSE"!==t||!o||o===a.userId?"JOIN"===t&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleJoin"),await this.signalingHandlers.handleJoin(n)):"OFFER"===t&&e.offer&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleOffer"),await this.signalingHandlers.handleOffer(n,e.offer)):"ANSWER"===t&&e.answer&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleAnswer"),await this.signalingHandlers.handleAnswer(n,e.answer)):"ICE_CANDIDATE"===t&&e.candidate&&n&&n!==a.userId?(console.log("[WebRTCManager] Dispatching to handleIceCandidate"),await this.signalingHandlers.handleIceCandidate(n,e.candidate)):"LEAVE"===t&&n?(console.log("[WebRTCManager] Dispatching to handleLeave"),this.signalingHandlers.handleLeave(n)):console.log("[WebRTCManager] Signal not handled - type:",t,"from:",n,"fromSelf:",n===a.userId,"reasons:",{JOIN:"JOIN"===t?`from=${!!n}, notSelf=${n!==a.userId}`:"N/A",OFFER:"OFFER"===t?`hasOffer=${!!e.offer}, from=${!!n}, notSelf=${n!==a.userId}`:"N/A",ANSWER:"ANSWER"===t?`hasAnswer=${!!e.answer}, from=${!!n}, notSelf=${n!==a.userId}`:"N/A",ICE:"ICE_CANDIDATE"===t?`hasCandidate=${!!e.candidate}, from=${!!n}, notSelf=${n!==a.userId}`:"N/A",LEAVE:"LEAVE"===t?`from=${!!n}`:"N/A"}):console.log("[WebRTCManager] Ignoring targeted message not meant for me")}attemptReconnection(e){return this.reconnectionManager.attempt(e)}_sendSignal(e){this.stateManager.safeSendMessage({type:"SIGNAL_SEND",message:e},function(){})}clearAll(){this.peerConnections.forEach(e=>{try{e.close()}catch(e){}}),this.peerConnections.clear(),this.peersThatLeft.clear(),this.remoteVideos.forEach(e=>{try{e.srcObject&&(e.srcObject=null)}catch(e){}e.remove()}),this.remoteVideos.clear(),this.remoteStreams.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}}(a,i),c=new class{constructor(e,t,n){this.stateManager=e,this.urlMonitorInterval=null,this.lastUrl=null,this.onWatchPageChange=t||(()=>{}),this.onNavigateToWatch=n||(()=>{})}start(){this.lastUrl=window.location.href,console.log("[URLSync] Starting URL monitoring, current URL:",this.lastUrl),this.urlMonitorInterval&&clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=setInterval(()=>{const e=window.location.href;if(e!==this.lastUrl){console.log("[URLSync] URL changed from",this.lastUrl,"to",e);const t=this.lastUrl?new URL(this.lastUrl).pathname:"",n=new URL(e).pathname,o=t.startsWith("/watch"),a=n.startsWith("/watch"),i=o&&a&&t!==n,r=!o&&a,s=o&&!a;this.lastUrl=e,i&&(console.log("[URLSync] Watch page changed - triggering sync reinitialization"),this.onWatchPageChange()),r&&(console.log("[URLSync] Navigated to /watch page - triggering sync initialization"),this.onNavigateToWatch());const l=this.stateManager.getState();l.partyActive&&s&&(console.log("[URLSync] Left /watch page - sending pause to all clients"),this.stateManager.safeSendMessage({type:"PLAY_PAUSE",control:"pause",timestamp:0})),l.partyActive&&a&&(i||!o&&a)?(console.log("[URLSync] Broadcasting /watch URL change to party"),this.stateManager.safeSendMessage({type:"URL_CHANGE",url:e})):a||s||console.log("[URLSync] Not broadcasting - not on /watch page (on:",n+")")}},500)}stop(){console.log("[URLSync] Stopping URL monitoring"),this.urlMonitorInterval&&(clearInterval(this.urlMonitorInterval),this.urlMonitorInterval=null),this.lastUrl=null}saveState(){const e=this.stateManager.getState();if(!e.partyActive)return;const t=this.getRestorationState()||{},n={roomId:e.roomId,currentTime:t.currentTime||null,isPlaying:"boolean"==typeof t.isPlaying?t.isPlaying:null,timestamp:Date.now()};sessionStorage.setItem("toperparty_restore",JSON.stringify(n))}clearState(){sessionStorage.removeItem("toperparty_restore")}getRestorationState(){const e=sessionStorage.getItem("toperparty_restore");if(!e)return null;try{const t=JSON.parse(e);if(Date.now()-t.timestamp<3e4)return t}catch(e){console.error("[toperparty] Failed to parse restoration state:",e)}return null}}(a,()=>{console.log("[Content Script] Watch page changed - reinitializing sync manager"),a.getState().partyActive?(console.log("[Content Script] Party is active, reinitializing sync manager"),s.teardown(),s.setup().catch(e=>{console.error("[Content Script] Failed to reinitialize sync manager:",e)})):console.log("[Content Script] Party not active, skipping sync manager reinitialization")},()=>{console.log("[Content Script] Navigated to /watch page"),a.getState().partyActive&&(console.log("[Content Script] Party is active, initializing sync manager"),s.teardown(),s.setup().catch(e=>{console.error("[Content Script] Failed to initialize sync manager:",e)}))});console.log("[Content Script] Managers initialized");let g=null,d=null;function p(){d||(d=setInterval(()=>{a.getState().partyActive&&(g&&!document.getElementById("toperparty-local-preview")&&(console.log("[Content Script] Local preview missing, re-attaching"),i.attachLocalPreview(g)),i.getRemoteVideos(),i.getRemoteStreams().forEach((e,t)=>{const n="toperparty-remote-"+t;if(!document.getElementById(n)){console.log("[Content Script] Remote video missing for peer:",t,"re-adding");const n=l.videoManager;n&&n.add&&n.add(t,e)}}))},1e3),console.log("[Content Script] Started video element monitoring"))}!function(){const e=c.getRestorationState();e&&(console.log("[Content Script] Restoring party state for room:",e.roomId),c.clearState(),a.setRestoringFlag(!0),setTimeout(function(){console.log("[Content Script] Sending RESTORE_PARTY message"),chrome.runtime.sendMessage({type:"RESTORE_PARTY",roomId:e.roomId},e=>{e&&e.success?(console.log("[Content Script] Party restoration successful - setting state with userId:",e.userId),a.startParty(e.userId,e.roomId),console.log("[Content Script] Re-obtaining media stream after navigation"),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{console.log("[Content Script] Media stream obtained after restoration"),g=e,l.setLocalStream(e),l.onLocalStreamAvailable(e),i.attachLocalPreview(e),s.teardown(),s.setup().catch(e=>{console.error("[Content Script] Failed to setup sync manager after restoration:",e)}),c.start(),p()}).catch(e=>{console.error("[Content Script] Failed to get media stream after restoration:",e)})):console.error("[Content Script] Party restoration failed:",e?e.error:"Unknown error"),setTimeout(function(){a.setRestoringFlag(!1)},2e3)})},1e3))}(),chrome.runtime.onMessage.addListener((e,t,n)=>{if(console.log("[Content Script] Received message:",e.type),"REQUEST_MEDIA_STREAM"===e.type)return console.log("[Content Script] Processing REQUEST_MEDIA_STREAM"),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{console.log("[Content Script] Media stream obtained, tracks:",e.getTracks().length),g=e,console.log("[Content Script] Setting local stream on WebRTC manager"),l.setLocalStream(e),l.onLocalStreamAvailable(e),console.log("[Content Script] Attaching local preview to UI"),i.attachLocalPreview(e),console.log("[Content Script] Local preview attached, sending success response"),n({success:!0})}).catch(e=>{console.error("[Content Script] Failed to get media stream:",e),n({success:!1,error:e.message})}),!0;if("PARTY_STARTED"===e.type&&(console.log("[Content Script] Party started:",e.userId,e.roomId),a.startParty(e.userId,e.roomId),setTimeout(()=>{r.setVolume(.15).then(()=>{console.log("[Content Script] Set Netflix volume to 15%")}).catch(e=>{console.warn("[Content Script] Failed to set volume:",e)})},1e3),s.teardown(),s.setup().catch(e=>{console.error("[Content Script] Failed to setup sync manager:",e)}),c.start(),p(),n({success:!0})),"PARTY_STOPPED"===e.type&&(console.log("[Content Script] Stopping party"),d&&(clearInterval(d),d=null,console.log("[Content Script] Stopped video element monitoring")),a.stopParty(),s.teardown(),c.stop(),c.clearState(),l.clearAll(),i.removeLocalPreview(),g&&(g.getTracks().forEach(e=>e.stop()),g=null),n({success:!0})),"SIGNAL"===e.type&&(console.log("[Content Script] Handling SIGNAL:",e.message?.type),l.handleSignal(e.message)),"APPLY_PLAYBACK_CONTROL"===e.type&&(console.log("[Content Script] Applying playback control:",e.control,"at",e.currentTime,"from",e.fromUserId),s.handlePlaybackControl(e.control,e.currentTime,e.fromUserId)),"APPLY_SEEK"===e.type&&s.handleSeek(e.currentTime,e.isPlaying,e.fromUserId),"APPLY_URL_CHANGE"===e.type){if(console.log("[Content Script] Received URL change request:",e.url,"from",e.fromUserId),a.restoringPartyState)return void console.log("[Content Script] Ignoring URL change - currently restoring party state");const t=new URL(e.url),n=window.location.pathname,o=n.startsWith("/watch");if(!t.pathname.startsWith("/watch"))return void console.log("[Content Script] Ignoring URL change - incoming URL is not a /watch page:",t.pathname);if(!o)return void console.log("[Content Script] Ignoring URL change - not currently on a /watch page (on:",n+")");console.log("[Content Script] Navigating to new watch page:",e.url),c.saveState(),window.location.href=e.url}"HANDLE_REQUEST_SYNC"===e.type&&s.handleRequestSync(e.fromUserId),"APPLY_SYNC_RESPONSE"===e.type&&(console.log("[Content Script] Applying sync response from",e.fromUserId,"URL:",e.url),s.handleSyncResponse(e.currentTime,e.isPlaying,e.fromUserId,e.url)),"REQUEST_INITIAL_SYNC_AND_PLAY"===e.type&&(console.log("[Content Script] Requesting initial sync and will auto-play when synced"),a.safeSendMessage({type:"REQUEST_SYNC"}))}),window.addEventListener("beforeunload",()=>{a.isActive()&&c.saveState()})})();
//# sourceMappingURL=content-script.js.map