(()=>{"use strict";const e=new class{constructor(){this.ws=null,this.localStream=null,this.isConnected=!1,this.roomId=null,this.userId=this.generateUserId()}generateUserId(){return"user_"+Math.random().toString(36).substr(2,9)}async startParty(e){return this.roomId=e||"default_room_"+Date.now(),new Promise((e,s)=>{try{chrome.tabs.query({url:"https://www.netflix.com/*"},t=>{0===t.length?this.getMediaStreamInBackground().then(()=>this.connectToSignalingServer(e,s)).catch(s):chrome.tabs.sendMessage(t[0].id,{type:"REQUEST_MEDIA_STREAM"},t=>{if(chrome.runtime.lastError)return console.warn("Content script not ready, trying background:",chrome.runtime.lastError),void this.getMediaStreamInBackground().then(()=>this.connectToSignalingServer(e,s)).catch(s);t&&t.success?this.connectToSignalingServer(e,s):this.getMediaStreamInBackground().then(()=>this.connectToSignalingServer(e,s)).catch(s)})})}catch(e){s(e)}})}async getMediaStreamInBackground(){console.log("Note: Media stream will be obtained from Netflix page")}connectToSignalingServer(e,s){try{this.ws=new WebSocket("ws://watch.toper.dev/ws"),this.ws.onopen=()=>{this.isConnected=!0,this.ws.send(JSON.stringify({type:"JOIN",userId:this.userId,roomId:this.roomId,timestamp:Date.now()})),chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"PARTY_STARTED",userId:this.userId,roomId:this.roomId}).catch(()=>{})})}),e()},this.ws.onmessage=e=>this.handleSignalingMessage(e.data),this.ws.onerror=e=>s(new Error("Failed to connect to signaling server")),this.ws.onclose=()=>{this.isConnected=!1,this.cleanup()}}catch(e){s(e)}}stopParty(e=!0){if(this.ws){if(e)try{this.ws.send(JSON.stringify({type:"LEAVE",userId:this.userId,roomId:this.roomId,timestamp:Date.now()}))}catch(e){}this.ws.close(),this.ws=null}this.cleanup(),this.isConnected=!1,chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"PARTY_STOPPED"}).catch(()=>{})})})}cleanup(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null)}async handleSignalingMessage(e){try{const s=JSON.parse(e);chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"SIGNAL",message:s}).catch(()=>{})})}),"PLAYBACK_CONTROL"===s.type&&s.userId!==this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_PLAYBACK_CONTROL",control:s.control,timestamp:s.timestamp,fromUserId:s.userId}).catch(()=>{})})}),"SYNC_PLAYBACK"===s.type&&s.userId!==this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SYNC_PLAYBACK",currentTime:s.currentTime,isPlaying:s.isPlaying,timestamp:s.timestamp,fromUserId:s.userId}).catch(()=>{})})}),"SEEK"===s.type&&s.userId!==this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SEEK",currentTime:s.currentTime,isPlaying:s.isPlaying,fromUserId:s.userId}).catch(()=>{})})}),"URL_CHANGE"===s.type&&s.userId!==this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_URL_CHANGE",url:s.url,fromUserId:s.userId}).catch(()=>{})})}),"REQUEST_SYNC"===s.type&&s.userId!==this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"HANDLE_REQUEST_SYNC",fromUserId:s.userId}).catch(()=>{})})}),"SYNC_RESPONSE"===s.type&&s.to===this.userId&&chrome.tabs.query({url:"https://www.netflix.com/*"},e=>{e.forEach(e=>{chrome.tabs.sendMessage(e.id,{type:"APPLY_SYNC_RESPONSE",currentTime:s.currentTime,isPlaying:s.isPlaying,fromUserId:s.fromUserId}).catch(()=>{})})})}catch(e){console.error("Error handling signaling message:",e)}}broadcastMessage(e){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e))}getStatus(){return{isConnected:this.isConnected,roomId:this.roomId,userId:this.userId,hasLocalStream:!!this.localStream}}};chrome.runtime.onMessage.addListener((s,t,r)=>{if("START_PARTY"===s.type)return e.startParty(s.roomId).then(()=>{r({success:!0})}).catch(e=>{r({success:!1,error:e.message})}),!0;if("STOP_PARTY"===s.type&&(e.stopParty(),r({success:!0})),"RESTORE_PARTY"===s.type)return e.stopParty(!1),e.userId=e.generateUserId(),e.startParty(s.roomId).then(()=>{r({success:!0})}).catch(e=>{r({success:!1,error:e.message})}),!0;if("GET_STATUS"===s.type)return r(e.getStatus()),!0;if("PLAY_PAUSE"===s.type&&(e.broadcastMessage({type:"PLAYBACK_CONTROL",control:s.control,timestamp:s.timestamp,userId:e.userId}),r({success:!0})),"SYNC_TIME"===s.type&&(e.broadcastMessage({type:"SYNC_PLAYBACK",currentTime:s.currentTime,isPlaying:s.isPlaying,userId:e.userId}),r({success:!0})),"SEEK"===s.type&&(e.broadcastMessage({type:"SEEK",currentTime:s.currentTime,isPlaying:s.isPlaying,userId:e.userId}),r({success:!0})),"URL_CHANGE"===s.type&&(e.broadcastMessage({type:"URL_CHANGE",url:s.url,userId:e.userId}),r({success:!0})),"REQUEST_SYNC"===s.type&&(e.broadcastMessage({type:"REQUEST_SYNC",userId:e.userId}),r({success:!0})),"SYNC_RESPONSE"===s.type&&(e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(JSON.stringify({type:"SYNC_RESPONSE",to:s.targetUserId,currentTime:s.currentTime,isPlaying:s.isPlaying,fromUserId:e.userId})),r({success:!0})),"SIGNAL_SEND"===s.type){const t=Object.assign({},s.message||{});if(t.userId=t.userId||e.userId,t.roomId=t.roomId||e.roomId,e.ws&&e.ws.readyState===WebSocket.OPEN)try{e.ws.send(JSON.stringify(t)),r({success:!0})}catch(e){r({success:!1,error:e.message})}else r({success:!1,error:"Not connected to signaling server"});return!0}})})();
//# sourceMappingURL=background.js.map